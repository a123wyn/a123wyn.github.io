DECLARE begin_time timestamp;
DECLARE end_time timestamp;
SET begin_time = '2021-05-31 16:00:00';
SET end_time = current_timestamp();
-- set begin_time = timestamp(concat(date_sub(current_date('Asia/Shanghai'),interval 1 day),' ',time(16,00,00)));
-- SET end_time = current_timestamp();
-- delete `admin-account-293313.DWD.theme_base_time_b_wyn` 
-- where prc_time >= timestamp(concat(current_date('Asia/Shanghai'),' ',time(00,00,00)));
-- insert `admin-account-293313.DWD.theme_base_time_b_wyn`
create or replace table `admin-account-293313.DWD.theme_base_time_b_wyn`
partition by prc_date
cluster by theme_name
as(
select 
a.*,
d.domain,
if(b.store_id is null,false,true) is_morethan10,
timestamp(datetime(o.time,'Asia/Shanghai')) order_time,
o.order_id
from
(
# theme_setting里的time就是prc
select 
date(timestamp(time),'Asia/Shanghai') prc_date,
timestamp(datetime(time,'Asia/Shanghai')) prc_time,
theme_name,
store_id
from
(
SELECT 
id,
store_id,
time,
max(if(p.key = 'operate_type',p.string_value,null)) operate_type,
max(if(p.key = 'theme_name',p.string_value,null)) theme_name,
FROM `shoplaza.shoplaza_analysis.events_all`
left join unnest (properties) p
WHERE event = 'theme_setting'
and time between begin_time and end_time
and platform = 'admin'
group by 1,2,3
)
-- where timestamp(time) between begin_time and end_time
where operate_type IN ('Add to the list', '添加到列表')
AND store_id IN (
SELECT store_id FROM `admin-account-293313.KAM.stores_information_xiaoyang`
WHERE internal = 0)
group by 1,2,3,4
)a
left join(
select 
store_id,
domain
from `admin-account-293313.DWD.store_Subscription_archer`
group by 1,2
)d using(store_id)
left join
(
SELECT 
prc_date,
store_id
FROM `admin-account-293313.key_table_forBI.store_utc8_order_count`
WHERE order_count > 10 and prc_date between date(begin_time,'Asia/Shanghai') and date(end_time,'Asia/Shanghai')
group by 1,2
)b using(prc_date,store_id)
left join 
(
select 
time,
store_id,
order_id
from `central-equinox-282901.shoplaza_analysis.realtime_events`
where event = 'place_order' and time between begin_time and end_time
group by 1,2,3
)o on a.prc_date = date(o.time,'Asia/Shanghai') and a.store_id = o.store_id
)