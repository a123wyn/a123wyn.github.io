DECLARE begin_time timestamp;
DECLARE end_time timestamp;
SET begin_time = timestamp(concat(date_sub(current_date(),interval 15 day),' ',time(16,00,00)));
-- set begin_time = timestamp(concat(current_date(),' ',time(extract(hour from TIMESTAMP_SUB(current_timestamp(),interval 1 hour)),00,00)));
SET end_time = current_timestamp();
-- delete `admin-account-293313.DWD.theme_base_time_c_wyn` 
-- where prc_time >= timestamp(datetime(timestamp(concat(current_date(),' ',time(extract(hour from TIMESTAMP_SUB(current_timestamp(),interval 1 hour)),00,00))),'Asia/Shanghai'));
-- SET begin_time = '2020-08-31 16:00:00';
-- SET end_time = '2020-12-31 15:59:59';
-- insert `admin-account-293313.DWD.theme_base_time_c_wyn`
create or replace table `admin-account-293313.DWD.theme_base_time_c_wyn`
partition by prc_date
cluster by event
as(
select 
a.*,
d.domain,
if(b.store_id is null,false,true) is_morethan10
from
(
select
date(prc_time) prc_date,
timestamp(prc_time) prc_time,
event,
_ip ip,
client_id,
country,
_os os,
_browser browser,
CASE WHEN _url LIKE '%gclid=%' OR _referrer_host LIKE '%gclid=%' THEN 'google_ads'
WHEN _referrer_host LIKE '%google.%' OR _latest_referrer_host LIKE '%google.%' THEN 'google'
WHEN _referrer_host LIKE '%facebook.%' OR _latest_referrer_host LIKE '%facebook.%' OR _browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
WHEN _referrer_host LIKE '%instagram.%' OR _latest_referrer_host LIKE '%instagram.%' OR _browser = 'Instagram' THEN 'instagram'
WHEN _referrer_host LIKE '%pinterest.%' OR _latest_referrer_host LIKE '%pinterest.%' OR _browser = 'Pinterest' THEN 'pinterest'
WHEN _referrer_host LIKE '%snapchat.%' OR _latest_referrer_host LIKE '%snapchat.%' OR _browser = 'Snapchat' THEN 'snapchat'
WHEN user_agent LIKE '%ByteLocale%' OR _referrer_host LIKE '%tiktok%.' OR _latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
WHEN _referrer_host LIKE '%youtube.%' OR _latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
WHEN _referrer_host LIKE '%yandex.%' OR _latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
WHEN _referrer_host LIKE '%yahoo.%' OR _latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
WHEN _referrer_host LIKE '%linkedin.%' OR _latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
ELSE 'others' END fx_channel,
theme_name,
_screen_width*_screen_height resolution,
store_id,
order_id,
payment_method,
usd_total
from `central-equinox-282901.shoplaza_analysis.realtime_events`
where event in ('pageview','add_to_cart','begin_checkout','place_order')
and time between begin_time and end_time
AND store_id IN (
SELECT store_id FROM `admin-account-293313.KAM.stores_information_xiaoyang`
WHERE internal = 0)
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
)a
#加上二级域名
left join(
select 
store_id,
domain
from `admin-account-293313.DWD.store_Subscription_archer`
group by 1,2
)d using(store_id)
#出单量大于10的店铺
left join
(
SELECT 
prc_date,
store_id
FROM `admin-account-293313.key_table_forBI.store_utc8_order_count`
WHERE order_count > 10 and prc_date between date(begin_time,'Asia/Shanghai') and date(end_time,'Asia/Shanghai')
group by 1,2
)b using(prc_date,store_id)
)