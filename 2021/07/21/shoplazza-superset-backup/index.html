<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Nananan">


    <meta name="subtitle" content="Nananan">


    <meta name="description" content="Pursue Excellence, Strive for Perfection.">


    <meta name="keywords" content="Nananan,python,Data-science,Big-data">


<title>shoplazza-superset-backup | Nananan&#39;s warehouse</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.0.2"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="alternate" href="/atom.xml" title="Nananan's warehouse" type="application/atom+xml">
</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">YNan&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">Home</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default"></input>
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>
    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">YNan&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/">Home</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <!-- <aside id="#aside">
                <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">YNan&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">Home</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default"></input>
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>
    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">YNan&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/">Home</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            </aside> -->
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Top of post↑</a>
        <a onclick="go_bottom()">Bottom of post↓</a>
        <a href="javascript:window.history.back();">Back</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">shoplazza-superset-backup</h1>
            
                <div class="post-meta">
                    
                        <span class="iconfont icon-user"></span>
                        <a itemprop="author" rel="author" href="/about">Nananan</a>
                    
                    <span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    
                        <span class="iconfont icon-date"></span>
                        <a href="#">2021-07-21&nbsp;&nbsp;10:13:53</a>
                    
                    <span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <!-- <span id="/2021/07/21/shoplazza-superset-backup/" class="leancloud-visitors view" data-flag-title="shoplazza-superset-backup">
                        <em class="post-meta-item-text">Pageviews:</em>
                        <i class="leancloud-visitors-count">loading</i>
                    </span> -->
                    
                        <!-- <span class="site-pv">
                            <span class="iconfont icon-eye"></span>
                            <a class="busuanzi-value" id="busuanzi_value_site_pv"></a>
                        </span> -->
                        <span id="busuanzi_container_page_pv">
                            <span class="iconfont icon-eye"></span>
                            <a id="busuanzi_value_page_pv"></a>
                        </span>
                    
                    <br />
                    
                    <span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    
                        <span class="iconfont icon-tags"></span>
                            
                                <a href="/tags/work/"># work</a>
                            
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="sales-GMV敏感数据"><a href="#sales-GMV敏感数据" class="headerlink" title="sales-GMV敏感数据"></a>sales-GMV敏感数据</h3><figure class="highlight n1ql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *,</span><br><span class="line">(<span class="keyword">case</span> <span class="keyword">when</span> proposed_plan = state <span class="keyword">then</span> <span class="literal">true</span> <span class="keyword">else</span> <span class="literal">false</span> <span class="keyword">end</span>) <span class="keyword">as</span> same_plan</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> *,</span><br><span class="line">(<span class="keyword">case</span> <span class="keyword">when</span> last_7_gmv &lt;=<span class="number">750</span> <span class="keyword">then</span> <span class="string">'lite'</span></span><br><span class="line">     <span class="keyword">when</span> last_7_gmv &lt;=<span class="number">2500</span> <span class="keyword">then</span> <span class="string">'advanced'</span></span><br><span class="line">     <span class="keyword">when</span> last_7_gmv &lt;= <span class="number">29750</span> <span class="keyword">then</span> <span class="string">'Flagship'</span></span><br><span class="line">     <span class="keyword">else</span> <span class="string">'pro2'</span> <span class="keyword">end</span>) proposed_plan</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">a.date_min,</span><br><span class="line">date(a.date_min) <span class="keyword">as</span> <span class="symbol">`date`</span>,</span><br><span class="line">a.usd_total,</span><br><span class="line">a.store_id,</span><br><span class="line">-- a.payment_method,</span><br><span class="line">company,</span><br><span class="line">created_at,</span><br><span class="line">domain,</span><br><span class="line">contact,</span><br><span class="line">category,</span><br><span class="line">submitter_name,</span><br><span class="line">plan,</span><br><span class="line">state,</span><br><span class="line">country,</span><br><span class="line">fx_channel,</span><br><span class="line">event,</span><br><span class="line"><span class="built_in">sum</span>(<span class="keyword">if</span>(date(date_min) &gt;= date_sub(current_date(<span class="string">'Asia/Shanghai'</span>),interval <span class="number">7</span> day) <span class="keyword">and</span> date(date_min) &lt; current_date(<span class="string">'Asia/Shanghai'</span>),usd_total,<span class="number">0</span>)) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> a.store_id) <span class="keyword">as</span> last_7_gmv</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> date_min <span class="keyword">AS</span> <span class="symbol">`date_min`</span>,</span><br><span class="line">      usd_total,</span><br><span class="line">--       pageview_ip <span class="keyword">AS</span> <span class="symbol">`pageview_ip`</span>,</span><br><span class="line">--       addcart_client <span class="keyword">AS</span> <span class="symbol">`addcart_client`</span>,</span><br><span class="line">--       checkout_client <span class="keyword">AS</span> <span class="symbol">`checkout_client`</span>,</span><br><span class="line">--       shipping_client <span class="keyword">AS</span> <span class="symbol">`shipping_client`</span>,</span><br><span class="line">--       payment_client <span class="keyword">AS</span> <span class="symbol">`payment_client`</span>,</span><br><span class="line">--       order_count <span class="keyword">AS</span> <span class="symbol">`order_count`</span>,</span><br><span class="line">      event <span class="keyword">AS</span> <span class="symbol">`event`</span>,</span><br><span class="line">      store_id <span class="keyword">AS</span> <span class="symbol">`store_id`</span>,</span><br><span class="line">--       ip_hll <span class="keyword">AS</span> <span class="symbol">`ip_hll`</span>,</span><br><span class="line">--       store_ip_pv <span class="keyword">AS</span> <span class="symbol">`store_ip_pv`</span>,</span><br><span class="line">--       client_hll <span class="keyword">AS</span> <span class="symbol">`client_hll`</span>,</span><br><span class="line">--       client_pv <span class="keyword">AS</span> <span class="symbol">`client_pv`</span>,</span><br><span class="line">--       order_hll <span class="keyword">AS</span> <span class="symbol">`order_hll`</span>,</span><br><span class="line">        country <span class="keyword">AS</span> <span class="symbol">`country`</span>,</span><br><span class="line">--        browser <span class="keyword">AS</span> <span class="symbol">`browser`</span>,</span><br><span class="line">--        fx_os <span class="keyword">AS</span> <span class="symbol">`fx_os`</span>,</span><br><span class="line">        fx_channel <span class="keyword">AS</span> <span class="symbol">`fx_channel`</span>,</span><br><span class="line">--        theme_name <span class="keyword">AS</span> <span class="symbol">`theme_name`</span>,</span><br><span class="line">--        payment_method <span class="keyword">AS</span> <span class="symbol">`payment_method`</span>,</span><br><span class="line">--        payment_channel <span class="keyword">AS</span> <span class="symbol">`payment_channel`</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="symbol">`admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin`</span> </span><br><span class="line"><span class="keyword">where</span> payment_method &lt;&gt; <span class="string">'cod'</span></span><br><span class="line"><span class="keyword">and</span> event = <span class="string">'place_order'</span>) a</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">(<span class="keyword">SELECT</span> <span class="keyword">distinct</span></span><br><span class="line">created_at,</span><br><span class="line">contact,</span><br><span class="line">store_id,</span><br><span class="line">domain,</span><br><span class="line">category,</span><br><span class="line">submitter_name,</span><br><span class="line">plan,</span><br><span class="line">company,</span><br><span class="line">state</span><br><span class="line"><span class="keyword">FROM</span> <span class="symbol">`admin-account-293313.KAM.stores_information_xiaoyang`</span>) <span class="built_in">e</span></span><br><span class="line"><span class="keyword">on</span> a.store_id = <span class="built_in">e</span>.store_id</span><br><span class="line">)</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="crm-omp-connecting"><a href="#crm-omp-connecting" class="headerlink" title="crm_omp_connecting"></a>crm_omp_connecting</h3><p>– with t as<br>– (<br>SELECT<br>store_id,<br>b.created_at,<br>b.created_time,<br>contact,<br>case when contact like ‘%@%’ then ‘email’ else ‘mobile’ end contact_type,<br>customer_name,<br>– created_at,<br>lead_source,<br>situation,<br>converted,<br>record,<br>b.url,<br>b.utm_name,<br>b.utm_source,<br>b.utm_content,<br>b.utm_term,<br>b.utm_medium,<br>b.opm_keyword_id,<br>b.keyword,<br>b.cost_baidu,<br>b.keyword_cost_baidu,<br>total_commission_30days,<br>total_commission_45days,<br>total_commission_60days,<br>total_commission_90days,<br>total_subscription_30days,<br>total_subscription_45days,<br>total_subscription_60days,<br>total_subscription_90days<br>FROM <code>admin-account-293313.KAM.stores_record</code>  a<br>left join <code>admin-account-293313.KAM.stores_information_xiaoyang</code>  b<br>using(contact)<br>– )</p>
<p>– left join<br>– (<br>– SELECT date,<br>– (cost/6.5) cost_baidu<br>– FROM <code>admin-account-293313.SEM.SEM-adv_daily_cost</code><br>– ) adv_table<br>– on adv_table.date = date(created_at)<br>– left join<br>– (<br>– SELECT<br>– keyword,<br>– keyword_id,<br>– date,<br>– sum(cost/6.5) as keyword_cost_baidu<br>– FROM <code>admin-account-293313.SEM.sem_keyword_details</code>  group by keyword,keyword_id,date<br>– ) keyword_table<br>– on a.opm_keyword_id = keyword_table.keyword_id<br>– and date(a.created_at) = keyword_table.date<br>– )</p>
<p>– select count(store_id),date(created_at) day from t<br>– where date(created_at) &gt;= ‘2021-07-01’<br>– and lead_source = ‘官网-试用名单’<br>– and utm_source like ‘%baidu%’<br>– group by 2 order by 2</p>
<p>– select distinct contact FROM <code>admin-account-293313.KAM.stores_record</code> </p>
<p>– select count(distinct contact),date(created_at) date from t where date(created_at) &gt;=’2021-07-01’ and  date(created_at) &lt;=’2021-07-15’ and utm_source like ‘%baidu%’ and lead_source = ‘官网-试用名单’ group by 2 order by 2<br>– select distinct store_id from t where date(created_at) = ‘2021-07-04’  and utm_source like ‘%baidu%’ and lead_source = ‘官网-试用名单’ </p>
<p>– select * from t<br>– where store_id = ‘170127’</p>
<h3 id="hll-casewhen-url-filter-order-count"><a href="#hll-casewhen-url-filter-order-count" class="headerlink" title="hll_casewhen_url_filter_order_count"></a>hll_casewhen_url_filter_order_count</h3><p>SELECT a.date_min,<br>    date(a.date_min) as <code>date</code>,<br>    datetime(a.date_min) as datetime,<br>    a.pageview_ip,<br>    a.addcart_client,<br>    a.checkout_client,<br>    a.shipping_client,<br>    a.shipping_method_client,<br>    a.payment_client,<br>    a.order_count,<br>    a.event,<br>    a.store_id,<br>–     a.ip_hll,<br>–     a.store_ip_pv,<br>    a.client_hll,<br>–     a.client_pv,<br>–     a.order_hll,<br>    a.country,<br>    a.browser,<br>    a.fx_os,<br>    a.fx_channel,<br>    a.theme_name,<br>    a.payment_method,<br>    a.payment_channel,<br>    c.company,<br>    c.submitter_name,<br>    d.new_customer,<br>    d.new_store,<br>    d.created_at,<br>    domain,<br>    primary_domain,<br>    d.state<br>FROM<br> (SELECT date_min AS <code>date_min</code>,<br>         pageview_ip AS <code>pageview_ip</code>,<br>         addcart_client AS <code>addcart_client</code>,<br>         checkout_client AS <code>checkout_client</code>,<br>         shipping_client AS <code>shipping_client</code>,<br>         shipping_method_client AS <code>shipping_method_client</code>,<br>         payment_client AS <code>payment_client</code>,<br>         order_count AS <code>order_count</code>,<br>         event AS <code>event</code>,<br>         store_id AS <code>store_id</code>,<br>–          ip_hll AS <code>ip_hll</code>,<br>–          store_ip_pv AS <code>store_ip_pv</code>,<br>         client_hll AS <code>client_hll</code>,<br>–          client_pv AS <code>client_pv</code>,<br>–          order_hll AS <code>order_hll</code>,<br>         country AS <code>country</code>,<br>         browser AS <code>browser</code>,<br>         fx_os AS <code>fx_os</code>,<br>         fx_channel AS <code>fx_channel</code>,<br>         theme_name AS <code>theme_name</code>,<br>         payment_method AS <code>payment_method</code>,<br>         payment_channel AS <code>payment_channel</code><br>  FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_utc8_casewhen_url_tongbin</code><br>where<br>store_id not in<br>(<br>‘1163’,<br>‘8988’,<br>‘10844’,<br>‘12632’,<br>‘12634’,<br>‘1172’,<br>‘6162’,<br>‘16666’,<br>‘17120’,<br>‘17600’,<br>‘53045’,<br>‘19824’,<br>‘17598’,<br>‘17122’,<br>‘1168’,<br>‘17602’,<br>‘17604’,<br>‘17606’,<br>‘21815’,<br>‘24507’,<br>‘24717’,<br>‘34683’,<br>‘36825’,<br>‘37315’,<br>‘37343’,<br>‘53139’,<br>‘50631’,<br>‘50993’,<br>‘51137’,<br>‘51157’,<br>‘73873’,<br>‘73875’,<br>‘95607’,<br>‘141161’,<br>‘41105’,<br>‘47981’,<br>‘48013’,<br>‘48415’,<br>‘41105’,<br>‘41147’,<br>‘41127’,<br>‘41119’,<br>‘46165’,<br>‘41135’,<br>‘41149’,<br>‘41141’,<br>‘39005’,<br>‘39369’,<br>‘39365’,<br>‘166799’,<br>‘177463’,<br>‘151513’,<br>‘164375’)<br>) a<br>INNER JOIN<br> (SELECT prc_date AS <code>prc_date</code>,<br>         store_id AS <code>store_id</code>,<br>         order_count AS <code>order_count</code><br>  FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>  WHERE order_count &gt; 10) b on date(a.date_min) = b.prc_date<br>and a.store_id = b.store_id<br>LEFT JOIN<br> (SELECT distinct store_id AS <code>store_id</code>,<br>                  company AS <code>company</code>,<br>                  submitter_name<br>  FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id<br>LEFT JOIN<br> (SELECT distinct store_id,<br>                  domain,<br>                  primary_domain,<br>                  new_customer,<br>                  new_store,<br>                  created_at,<br>                  state<br>  FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d on b.store_id = d.store_id</p>
<h3 id="店铺组-店铺Online-gmv占比"><a href="#店铺组-店铺Online-gmv占比" class="headerlink" title="店铺组-店铺Online_gmv占比"></a>店铺组-店铺Online_gmv占比</h3><p> SELECT<br>a.prc_date ,a.theme_name ,(a.online_gmv /b.online_gmv ) gmv_percent<br>from<br>(SELECT DATE(time, “Asia/Shanghai”) prc_date,theme_name,sum(usd_total) online_gmv<br>FROM <code>central-equinox-282901.shoplaza_analysis.realtime_events</code> WHERE DATE(time, “Asia/Shanghai”) &gt;= “2021-01-01”–   and DATE(time, “Asia/Shanghai”) &lt; “2021-07-06”<br>– and  DATE(time, “Asia/Shanghai”) = “2021-07-01”<br>and event = “place_order”<br>and payment_method != ‘cod’<br>and platform = ‘shop’<br>and theme_name != ‘’<br>and theme_name is not null<br>and theme_name != ‘ ‘<br>group by prc_date,theme_name ) a<br>left join<br>(SELECT DATE(time, “Asia/Shanghai”) prc_date,sum(usd_total) online_gmv<br>FROM <code>central-equinox-282901.shoplaza_analysis.realtime_events</code> WHERE DATE(time, “Asia/Shanghai”) &gt;= “2021-01-01”–   and DATE(time, “Asia/Shanghai”) &lt; “2021-07-06”<br>– and  DATE(time, “Asia/Shanghai”) = “2021-07-01”<br>and event = “place_order”<br>and payment_method != ‘cod’<br>and platform = ‘shop’<br>and theme_name != ‘’<br>and theme_name is not null<br>and theme_name != ‘ ‘<br>group by prc_date ) b<br>on a.prc_date = b.prc_date </p>
<h3 id="order-count-test-forstella"><a href="#order-count-test-forstella" class="headerlink" title="order_count_test_forstella"></a>order_count_test_forstella</h3><p>SELECT a.date_min,<br>    date(a.date_min) as <code>date</code>,<br>    datetime(a.date_min) as datetime,<br>    a.pageview_ip,<br>    a.addcart_client,<br>    a.checkout_client,<br>    a.shipping_client,<br>    a.shipping_method_client,<br>    a.payment_client,<br>    a.order_count,<br>    a.event,<br>    a.store_id,<br>    a.ip_hll,<br>–     a.store_ip_pv,<br>    a.client_hll,<br>–     a.client_pv,<br>    a.order_hll,<br>    a.country,<br>    a.browser,<br>    a.fx_os,<br>    a.fx_channel,<br>    a.theme_name,<br>    a.payment_method,<br>    a.payment_channel,<br>    c.company,<br>    domain,<br>    primary_domain,<br>    d.state,<br>    case when b.order_count &gt; 10 then true<br>         else false end as more_then_10_order<br>FROM<br> (SELECT date_min AS <code>date_min</code>,<br>         pageview_ip AS <code>pageview_ip</code>,<br>         addcart_client AS <code>addcart_client</code>,<br>         checkout_client AS <code>checkout_client</code>,<br>         shipping_client AS <code>shipping_client</code>,<br>         shipping_method_client AS <code>shipping_method_client</code>,<br>         payment_client AS <code>payment_client</code>,<br>         order_count AS <code>order_count</code>,<br>         event AS <code>event</code>,<br>         store_id AS <code>store_id</code>,<br>         ip_hll AS <code>ip_hll</code>,<br>–          store_ip_pv AS <code>store_ip_pv</code>,<br>         client_hll AS <code>client_hll</code>,<br>–          client_pv AS <code>client_pv</code>,<br>         order_hll AS <code>order_hll</code>,<br>         country AS <code>country</code>,<br>         browser AS <code>browser</code>,<br>         fx_os AS <code>fx_os</code>,<br>         fx_channel AS <code>fx_channel</code>,<br>         theme_name AS <code>theme_name</code>,<br>         payment_method AS <code>payment_method</code>,<br>         payment_channel AS <code>payment_channel</code><br>  FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code>) a<br>LEFT  JOIN<br> (SELECT prc_date AS <code>prc_date</code>,<br>         store_id AS <code>store_id</code>,<br>         order_count AS <code>order_count</code> –维度<br>  FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>  ) b<br>on date(a.date_min) = b.prc_date<br>and a.store_id = b.store_id<br>LEFT JOIN<br> (SELECT distinct store_id AS <code>store_id</code>,<br>                  company AS <code>company</code>,<br>  FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id<br>LEFT JOIN<br> (SELECT distinct store_id,<br>                  domain,<br>                  primary_domain,<br>                  state<br>  FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d on b.store_id = d.store_id</p>
<h3 id="支付组数据"><a href="#支付组数据" class="headerlink" title="支付组数据"></a>支付组数据</h3><p>SELECT<br>date(time,’Asia/Shanghai’) prc_date,<br>country,<br>trim(payment_channel) payment_channel,<br>– count(distinct case when event = ‘place_order’ and payment_method != ‘cod’ then order_id end) as order_num,<br>order_id,<br>– count(distinct case when event = ‘add_payment_info’ then client_id end) as pay_info_num,<br>client_id,<br>event,<br>usd_total<br>FROM <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>where platform = ‘shop’<br>and payment_method != ‘cod’<br>and time &gt; timestamp(format_date(“%Y-%m-%d 16:00:00”,date_sub(current_date(‘Asia/Shanghai’),interval 31 day)))<br>and event in (‘place_order’,’add_payment_info’)<br>– group by 1,2,3</p>
<h3 id="hll-casewhen-filter-order-count"><a href="#hll-casewhen-filter-order-count" class="headerlink" title="hll_casewhen_filter_order_count"></a>hll_casewhen_filter_order_count</h3><p>SELECT a.date_min,<br>    date(a.date_min) as <code>date</code>,<br>    datetime(a.date_min) as datetime,<br>    a.pageview_ip,<br>    a.addcart_client,<br>    a.checkout_client,<br>    a.shipping_client,<br>    a.shipping_method_client,<br>    a.payment_client,<br>    a.order_count,<br>    a.event,<br>    a.store_id,<br>    a.ip_hll,<br>–     a.store_ip_pv,<br>    a.client_hll,<br>–     a.client_pv,<br>    a.order_hll,<br>    a.country,<br>    a.browser,<br>    a.fx_os,<br>    a.fx_channel,<br>    a.theme_name,<br>    a.payment_method,<br>    a.payment_channel,<br>    c.company,<br>    c.submitter_name,<br>    d.new_customer,<br>    d.new_store,<br>    d.created_at,<br>    domain,<br>    primary_domain,<br>    d.state<br>FROM<br> (SELECT date_min AS <code>date_min</code>,<br>         pageview_ip AS <code>pageview_ip</code>,<br>         addcart_client AS <code>addcart_client</code>,<br>         checkout_client AS <code>checkout_client</code>,<br>         shipping_client AS <code>shipping_client</code>,<br>         shipping_method_client AS <code>shipping_method_client</code>,<br>         payment_client AS <code>payment_client</code>,<br>         order_count AS <code>order_count</code>,<br>         event AS <code>event</code>,<br>         store_id AS <code>store_id</code>,<br>         ip_hll AS <code>ip_hll</code>,<br>–          store_ip_pv AS <code>store_ip_pv</code>,<br>         client_hll AS <code>client_hll</code>,<br>–          client_pv AS <code>client_pv</code>,<br>         order_hll AS <code>order_hll</code>,<br>         country AS <code>country</code>,<br>         browser AS <code>browser</code>,<br>         fx_os AS <code>fx_os</code>,<br>         fx_channel AS <code>fx_channel</code>,<br>         theme_name AS <code>theme_name</code>,<br>         payment_method AS <code>payment_method</code>,<br>         payment_channel AS <code>payment_channel</code><br>  FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code>) a<br>INNER JOIN<br> (SELECT prc_date AS <code>prc_date</code>,<br>         store_id AS <code>store_id</code>,<br>         order_count AS <code>order_count</code><br>  FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>  WHERE order_count &gt; 10) b on date(a.date_min) = b.prc_date<br>and a.store_id = b.store_id<br>LEFT JOIN<br> (SELECT distinct store_id AS <code>store_id</code>,<br>                  company AS <code>company</code>,<br>                  submitter_name<br>  FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id<br>LEFT JOIN<br> (SELECT distinct store_id,<br>                  domain,<br>                  primary_domain,<br>                  new_customer,<br>                  new_store,<br>                  created_at,<br>                  state<br>  FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d on b.store_id = d.store_id</p>
<h3 id="Query-KAM-comission-plan-GMV-xiaoyang-02-18-2021-12-01-43"><a href="#Query-KAM-comission-plan-GMV-xiaoyang-02-18-2021-12-01-43" class="headerlink" title="Query KAM.comission_plan_GMV_xiaoyang 02/18/2021 12:01:43"></a>Query KAM.comission_plan_GMV_xiaoyang 02/18/2021 12:01:43</h3><p>– select<br>– prc_date,<br>– sum(plan_usd),<br>– sum(commission_usd),<br>– from<br>– (<br>select<br>store_id,<br>prc_date,<br>commission_plan_table.* except (store_id,prc_date),<br>gmv<br>from<br>(<br>select<br>prc_date,<br>store_id,<br>company,<br>ifnull(plan_usd,0) plan_usd,<br>ifnull(commission_usd,0) commission_usd<br>– plan<br>from<br>(<br>SELECT<br>date(paid_at) prc_date,<br>store_id,<br>– time_interval_plan as plan,<br>company,<br>sum(price) as plan_usd<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>group by 1,2,3<br>) plan_table<br>full join<br>(<br>SELECT<br>date(end_time) prc_date,<br>company,<br>store_id,<br>– plan,<br>sum(commission_in_usd) as commission_usd<br>FROM <code>admin-account-293313.KAM.stores_commission__information_xiaoyang</code><br>where commission_paid_state = ‘paid’<br>group by 1,2,3<br>) commission_table<br>using (prc_date,store_id,company)<br>) commission_plan_table<br>full join<br>(<br>SELECT<br>store_id,<br>DATE(date_min) as prc_date,<br>SUM(usd_total) AS gmv,<br>FROM<br><code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>where event = ‘place_order’<br>AND payment_method != ‘cod’<br>group by 1,2<br>) gmv_table<br>using (store_id,prc_date)<br>– )</p>
<h3 id="灰度数据（每日指标）"><a href="#灰度数据（每日指标）" class="headerlink" title="灰度数据（每日指标）"></a>灰度数据（每日指标）</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.pageview_ip,<br>a.addcart_client,<br>a.checkout_client,<br>a.shipping_client,<br>a.shipping_method_client,<br>a.payment_client,<br>a.order_count,<br>a.event,<br>a.store_id,<br>a.ip_hll,<br>a.store_ip_pv,<br>a.client_hll,<br>a.client_pv,<br>a.order_hll,<br>a.country,<br>a.browser,<br>a.fx_os,<br>a.fx_channel,<br>a.theme_name,<br>a.payment_method,<br>a.payment_channel,<br>c.company,<br>d.created_at,<br>d.state</p>
<p>– b.order_count as <code>count_by_store</code><br>FROM<br>(SELECT date_min AS <code>date_min</code>,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      addcart_client AS <code>addcart_client</code>,<br>      checkout_client AS <code>checkout_client</code>,<br>      shipping_client AS <code>shipping_client</code>,<br>      shipping_method_client AS <code>shipping_method_client</code>,<br>      payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>      event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      ip_hll AS <code>ip_hll</code>,<br>      store_ip_pv AS <code>store_ip_pv</code>,<br>      client_hll AS <code>client_hll</code>,<br>      client_pv AS <code>client_pv</code>,<br>      order_hll AS <code>order_hll</code>,<br>      country AS <code>country</code>,<br>      browser AS <code>browser</code>,<br>      fx_os AS <code>fx_os</code>,<br>      fx_channel AS <code>fx_channel</code>,<br>      theme_name AS <code>theme_name</code>,<br>      payment_method AS <code>payment_method</code>,<br>      payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>– where store_id in<br>– (‘143207’,<br>– ‘141051’,<br>– ‘141011’,<br>– ‘135367’,<br>– ‘133519’,<br>– ‘129307’,<br>– ‘127789’,<br>– ‘127713’,<br>– ‘127043’,<br>– ‘126595’,<br>– ‘125925’,<br>– ‘125859’,<br>– ‘125543’,<br>– ‘125531’,<br>– ‘125445’,<br>– ‘125205’,<br>– ‘124349’,<br>– ‘123877’,<br>– ‘123029’,<br>– ‘122895’,<br>– ‘122675’,<br>– ‘118775’,<br>– ‘118001’,<br>– ‘115877’,<br>– ‘115173’,<br>– ‘112687’,<br>– ‘112685’,<br>– ‘112619’,<br>– ‘111637’,<br>– ‘110061’,<br>– ‘107397’,<br>– ‘101055’,<br>– ‘99121’,<br>– ‘98075’,<br>– ‘95701’,<br>– ‘95661’,<br>– ‘95563’,<br>– ‘92929’,<br>– ‘91929’,<br>– ‘91025’,<br>– ‘90841’,<br>– ‘88893’,<br>– ‘87105’,<br>– ‘86335’,<br>– ‘85981’,<br>– ‘85353’,<br>– ‘83295’,<br>– ‘79905’,<br>– ‘78973’,<br>– ‘77809’,<br>– ‘77315’,<br>– ‘77089’,<br>– ‘76347’,<br>– ‘75703’,<br>– ‘74825’,<br>– ‘71785’,<br>– ‘71087’,<br>– ‘70751’,<br>– ‘67025’,<br>– ‘61311’,<br>– ‘56497’,<br>– ‘52327’,<br>– ‘47067’,<br>– ‘46633’,<br>– ‘44893’,<br>– ‘43189’,<br>– ‘39931’)</p>
<p>) a<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code><br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct store_id,<br>created_at,<br>state<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on a.store_id = d.store_id</p>
<h3 id="sales-店铺订阅与信息"><a href="#sales-店铺订阅与信息" class="headerlink" title="sales-店铺订阅与信息"></a>sales-店铺订阅与信息</h3><p>SELECT<br>store_id,<br>created_at,<br>domain,<br>contact,<br>state,<br>expired_at,<br>price,<br>paid_at,<br>time_interval_plan,<br>submitter_name,<br>company,<br>card_brand,<br>card_last4,<br>internal,<br>client_first_paid_at,<br>new_customer<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>where company is not null</p>
<h3 id="风控关联店铺"><a href="#风控关联店铺" class="headerlink" title="风控关联店铺"></a>风控关联店铺</h3><p>select<br>store_id,<br>store_id_related,<br>store_company,<br>related_store_company,<br>service_email,<br>financial_email,<br>card,<br>merchant_id<br>FROM <code>admin-account-293313.disputes_related_view.relateing_stores</code> </p>
<p>union all<br>select<br>store_id_related as store_id,<br>store_id as store_id_related,<br>related_store_company as store_company,<br>store_company as related_store_company,<br>service_email,<br>financial_email,<br>card,<br>merchant_id<br>FROM <code>admin-account-293313.disputes_related_view.relateing_stores</code> </p>
<h3 id="stella-店铺DOD"><a href="#stella-店铺DOD" class="headerlink" title="stella-店铺DOD"></a>stella-店铺DOD</h3><p>with table_a as<br>(<br>SELECT<br>    a.date_min,<br>    date(a.date_min) as <code>date</code>,<br>    a.pageview_ip,<br>    b.order_count,<br>–     a.addcart_client,<br>–     a.checkout_client,<br>–     a.shipping_client,<br>–     a.shipping_method_client,<br>–     a.payment_client,<br>–     a.order_count,<br>–     a.event,<br>    a.store_id,<br>–     a.ip_hll,<br>–     a.client_hll,<br>–     a.order_hll,<br>–     a.country,<br>–     a.browser,<br>–     a.fx_os,<br>–     a.fx_channel,<br>–     a.theme_name,<br>–     a.payment_method,<br>–     a.payment_channel,<br>    c.company,<br>–     c.submitter_name,<br>–     d.new_customer,<br>–     d.new_store,<br>–     d.created_at,<br>–     d.state,<br>    e.online_gmv<br>FROM<br> (SELECT date_min AS <code>date_min</code>,<br>         pageview_ip AS <code>pageview_ip</code>,<br>–          addcart_client AS <code>addcart_client</code>,<br>–          checkout_client AS <code>checkout_client</code>,<br>–          shipping_client AS <code>shipping_client</code>,<br>–          shipping_method_client AS <code>shipping_method_client</code>,<br>–          payment_client AS <code>payment_client</code>,<br>         order_count AS <code>order_count</code>,<br>–          event AS <code>event</code>,<br>         store_id AS <code>store_id</code>,<br>–          ip_hll AS <code>ip_hll</code>,<br>–          store_ip_pv AS <code>store_ip_pv</code>,<br>–          client_hll AS <code>client_hll</code>,<br>–          client_pv AS <code>client_pv</code>,<br>–          order_hll AS <code>order_hll</code>,<br>–          country AS <code>country</code>,<br>–          browser AS <code>browser</code>,<br>–          fx_os AS <code>fx_os</code>,<br>–          fx_channel AS <code>fx_channel</code>,<br>–          theme_name AS <code>theme_name</code>,<br>–          payment_method AS <code>payment_method</code>,<br>–          payment_channel AS <code>payment_channel</code><br>  FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code>) a<br>INNER JOIN<br> (SELECT prc_date AS <code>prc_date</code>,<br>         store_id AS <code>store_id</code>,<br>         order_count AS <code>order_count</code><br>  FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>  WHERE order_count &gt; 10) b on date(a.date_min) = b.prc_date<br>and a.store_id = b.store_id<br>LEFT JOIN<br> (SELECT distinct store_id AS <code>store_id</code>,<br>                  company AS <code>company</code>,<br>                  submitter_name<br>  FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id<br>– LEFT JOIN<br>–  (SELECT distinct store_id,<br>–                   new_customer,<br>–                   new_store,<br>–                   created_at,<br>–                   state<br>–   FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d on b.store_id = d.store_id<br>left join<br>(SELECT<br>store_id,<br>date_bj,<br>online_gmv<br>FROM <code>admin-account-293313.key_table_forBI.store_gmv_all</code> ) e<br>on a.store_id =e.store_id<br>and date(a.date_min) = e.date_bj<br>)<br>,</p>
<p>t as<br>(<br>select<br>store_id,<br>date,<br>online_gmv,<br>order_count,<br>company,<br>hll_count.merge(pageview_ip) uv,<br>from table_a<br>where date &gt;=’2021-06-01’<br>group by 1,2,3,4,5<br>having uv &gt; 200<br>)</p>
<p>select<br>distinct<br>t1.store_id,<br>t1.company,<br>t1.date today,<br>t2.date yesterday,<br>t1.uv today_uv,<br>t2.uv yesterday_uv,<br>(t1.uv  - t2.uv )/ t2.uv as uv_DOD,</p>
<p>t1.order_count today_order_count,<br>t2.order_count yesterday_order_count,<br>(t1.order_count  - t2.order_count )/ t2.order_count as order_DOD,</p>
<p>t1.online_gmv today_gmv,<br>t2.online_gmv yesterday_gmv<br>from t t1,t t2<br>where t1.store_id = t2.store_id<br>and t1.date = date_add(t2.date,interval 1 day)</p>
<h3 id="主题组-页面加载时间相关"><a href="#主题组-页面加载时间相关" class="headerlink" title="主题组-页面加载时间相关"></a>主题组-页面加载时间相关</h3><p>SELECT<br>time,<br>country,<br>os,<br>browser,theme_name,<br>   (case<br>      when url like ‘%gclid=%’ or referrer_host like ‘%gclid=%’ then ‘google_ads’<br>    when referrer_host like ‘%google.%’ then ‘google’<br>    when referrer_host like ‘%facebook.%’ or browser in(‘Facebook’,’Facebook Messenger’,’FacebookBot’) then ‘facebook’<br>    when referrer_host like ‘%instagram.%’ or browser = ‘Instagram’ then ‘instagram’<br>    when referrer_host like ‘%pinterest.%’ or browser = ‘Pinterest’ then ‘pinterest’<br>    when referrer_host like ‘%snapchat.%’ or browser = ‘Snapchat’ then ‘snapchat’<br>    when referrer_host like ‘%tiktok%.’  then ‘tiktok’ else ‘others’ end ) fx_channel,–渠道分类<br>   (CASE<br>     WHEN url_path LIKE ‘%/collections/%’ THEN ‘collections’<br>     WHEN url_path LIKE ‘%/products/%’ THEN ‘product’<br>     WHEN url_path LIKE ‘%/cart%’ THEN ‘cart’<br>     WHEN url_path LIKE ‘%/checkout/%’ THEN ‘checkout’<br>     ELSE ‘/‘<br>     END<br>    ) path,<br>    ifnull(first_contentful_paint,0) first_contentful_paint,<br>    ifnull(domready,0) domready,<br>    ifnull(allloaded,0) allloaded<br>FROM <code>admin-account-293313.web_related.web_performance</code></p>
<h3 id="店铺组-店铺当前使用主题"><a href="#店铺组-店铺当前使用主题" class="headerlink" title="店铺组-店铺当前使用主题"></a>店铺组-店铺当前使用主题</h3><p>select prc_date,<br>store_id,<br>a.theme_name as using_theme_name,<br>b.theme_name,<br>order_count<br>from<br>(<br>select distinct store_id, first_value(theme_name) over(partition by store_id order by date_min desc) theme_name<br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>– where event = ‘pageview’<br>– and platform = ‘shop’<br>where theme_name is not null<br>and theme_name != ‘’<br>and theme_name != ‘ ‘<br>) a<br>join<br>(<br>SELECT<br>date(time,’Asia/Shanghai’) prc_date,<br>store_id,<br>theme_name,<br>count(distinct order_id) order_count<br>FROM <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>where event = ‘place_order’<br>and payment_method != ‘cod’<br>and platform = ‘shop’<br>and theme_name != ‘’<br>and theme_name is not null<br>and theme_name != ‘ ‘<br>group by 1,2,3<br>) b<br>using (store_id)</p>
<h3 id="Media-Solutions-google-users"><a href="#Media-Solutions-google-users" class="headerlink" title="Media_Solutions_google_users"></a>Media_Solutions_google_users</h3><p>– select a.*,<br>– (case when gmv_online &gt;1  then true else false end) as active_store<br>– from<br>– (SELECT store_id AS <code>store_id</code>,<br>–   company AS <code>company</code>,<br>–   contact AS <code>contact</code>,<br>–   created_at AS <code>created_at</code>,<br>–   domain AS <code>domain</code>,<br>–   google_feed_tag AS <code>google_feed_tag</code>,<br>–   time_at AS <code>time_at</code>,<br>–   ga_new AS <code>ga_new</code>,<br>–   ads AS <code>ads</code>,<br>–   feed_new AS <code>feed_new</code>,<br>–   feed_alive_new AS <code>feed_alive_new</code>,<br>–   oauth AS <code>oauth</code>,<br>–   total_new AS <code>total_new</code>,<br>–   feed_old AS <code>feed_old</code>,<br>–   ga_old AS <code>ga_old</code>,<br>–   total_old AS <code>total_old</code>,<br>–   total AS <code>total</code>,<br>–   total_feed AS <code>total_feed</code>,<br>–   total_ga AS <code>total_ga</code>,<br>–   shopping_new AS <code>shopping_new</code>,<br>–   freelisting_new AS <code>freelisting_new</code>,<br>–   feed_alive_old AS <code>feed_alive_old</code>,<br>–   total_feed_alive AS <code>total_feed_alive</code>,<br>–   shopping_old AS <code>shopping_old</code>,<br>–   freelisting_old AS <code>freelisting_old</code>,<br>–   free_total AS <code>free_total</code>,<br>–   shopping_total AS <code>shopping_total</code>,<br>–   gmc_approved_total AS <code>gmc_approved_total</code>,<br>–   feed_and_new AS <code>feed_and_new</code><br>– FROM <code>google_sheet_schedule</code>.<code>Media_Solutions_google_users</code>) a<br>– left join<br>– (SELECT store_id,sum(online_gmv) as gmv_online FROM <code>admin-account-293313.key_table_forBI.store_gmv_all</code><br>– WHERE date_bj &gt; date_sub(current_date(“Asia/Shanghai”) ,INTERVAL 30 day)<br>– group by store_id) b<br>– on cast (a.store_id as string)= b.store_id</p>
<p>select a.*,<br>(case when gmv_online &gt;1  then true else false end) as active_store,<br>c.google_online_gmv, c.google_order_count<br>from<br>(SELECT store_id AS <code>store_id</code>,<br>   company AS <code>company</code>,<br>   contact AS <code>contact</code>,<br>   created_at AS <code>created_at</code>,<br>   domain AS <code>domain</code>,<br>   google_feed_tag AS <code>google_feed_tag</code>,<br>   time_at AS <code>time_at</code>,<br>   ga_new AS <code>ga_new</code>,<br>   ads AS <code>ads</code>,<br>   feed_new AS <code>feed_new</code>,<br>   feed_alive_new AS <code>feed_alive_new</code>,<br>   oauth AS <code>oauth</code>,<br>   total_new AS <code>total_new</code>,<br>   feed_old AS <code>feed_old</code>,<br>   ga_old AS <code>ga_old</code>,<br>   total_old AS <code>total_old</code>,<br>   total AS <code>total</code>,<br>   total_feed AS <code>total_feed</code>,<br>   total_ga AS <code>total_ga</code>,<br>   shopping_new AS <code>shopping_new</code>,<br>   freelisting_new AS <code>freelisting_new</code>,<br>   feed_alive_old AS <code>feed_alive_old</code>,<br>   total_feed_alive AS <code>total_feed_alive</code>,<br>   shopping_old AS <code>shopping_old</code>,<br>   freelisting_old AS <code>freelisting_old</code>,<br>   free_total AS <code>free_total</code>,<br>   shopping_total AS <code>shopping_total</code>,<br>   gmc_approved_total AS <code>gmc_approved_total</code>,<br>   feed_and_new AS <code>feed_and_new</code><br>FROM <code>google_sheet_schedule</code>.<code>Media_Solutions_google_users</code>) a<br>left join<br>(SELECT store_id,sum(online_gmv) as gmv_online FROM <code>admin-account-293313.key_table_forBI.store_gmv_all</code><br>WHERE date_bj &gt; date_sub(current_date(“Asia/Shanghai”) ,INTERVAL 30 day)  – 用于过滤最近30天的总online_gmv&gt;1的店铺（活跃店铺）<br>group by store_id) b<br>on cast (a.store_id as string)= b.store_id<br>– Google GMV &amp; Google order<br>LEFT JOIN<br>  (SELECT<br>  store_id,<br>  SUM(usd_total ) google_online_gmv,<br>  hll_count.MERGE(order_hll) google_order_count<br>  FROM (<br>    SELECT<br>    usd_total,<br>    store_id,<br>    order_hll<br>    FROM<br>    <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>    WHERE<br>    payment_method &lt;&gt; ‘cod’<br>    AND event = ‘place_order’<br>    AND fx_channel IN( “google”,”google_ads”)<br>    AND DATE(date_min ) &gt;= ‘2021-01-01’<br>    AND DATE(date_min) &lt;= CURRENT_DATE(‘Asia/Shanghai’))<br>  GROUP BY<br>  store_id) AS c<br>ON a.store_id = c.store_id</p>
<h3 id="Untitled-Query-2-06-17-2021-09-03-20test"><a href="#Untitled-Query-2-06-17-2021-09-03-20test" class="headerlink" title="Untitled Query 2 06/17/2021 09:03:20test"></a>Untitled Query 2 06/17/2021 09:03:20test</h3><p>SELECT * FROM <code>admin-account-293313.google_sheet_schedule.Media_Solutions_gmc_product_detail_copy</code> LIMIT 1000</p>
<h3 id="百度渠道ROI"><a href="#百度渠道ROI" class="headerlink" title="百度渠道ROI"></a>百度渠道ROI</h3><p>select<br>utm_source,<br>date(created_at) prc_date,<br>cost_baidu,<br>sum(total_commission_30days) total_commission_30days,<br>sum(total_commission_45days) total_commission_45days,<br>sum(total_commission_60days) total_commission_60days,<br>sum(total_commission_90days) total_commission_90days,<br>sum(total_subscription_30days) total_subscription_30days,<br>sum(total_subscription_45days) total_subscription_45days,<br>sum(total_subscription_60days) total_subscription_60days,<br>sum(total_subscription_90days) total_subscription_90days<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code><br>where utm_source = ‘baidu’<br>group by 1,2,3<br>order by prc_date desc<br>– join</p>
<h3 id="markting-sem广告投放"><a href="#markting-sem广告投放" class="headerlink" title="markting-sem广告投放"></a>markting-sem广告投放</h3><p>select * FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code></p>
<h3 id="sale-BD"><a href="#sale-BD" class="headerlink" title="sale-BD"></a>sale-BD</h3><p>select *,<br>(case when proposed_plan = state then true else false end) as same_plan<br>from<br>(<br>select *,<br>(case when last_7_gmv &lt;=750 then ‘lite’<br>     when last_7_gmv &lt;=2500 then ‘advanced’<br>     when last_7_gmv &lt;= 7437.5 then ‘Flagship’<br>     else ‘pro2’ end) proposed_plan<br>     from<br>(<br>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.usd_total,<br>a.store_id,<br>– a.payment_method,<br>company,<br>created_at,<br>domain,<br>contact,<br>category,<br>submitter_name,<br>plan,<br>state,<br>country,<br>fx_channel,<br>sum(if(date(date_min) &gt;= date_sub(current_date(‘Asia/Shanghai’),interval 7 day) and date(date_min) &lt; current_date(‘Asia/Shanghai’),usd_total,0)) over(partition by a.store_id) as last_7_gmv<br>FROM<br>(<br>SELECT date_min AS <code>date_min</code>,<br>      usd_total,<br>–       pageview_ip AS <code>pageview_ip</code>,<br>–       addcart_client AS <code>addcart_client</code>,<br>–       checkout_client AS <code>checkout_client</code>,<br>–       shipping_client AS <code>shipping_client</code>,<br>–       payment_client AS <code>payment_client</code>,<br>–       order_count AS <code>order_count</code>,<br>–       event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>–       ip_hll AS <code>ip_hll</code>,<br>–       store_ip_pv AS <code>store_ip_pv</code>,<br>–       client_hll AS <code>client_hll</code>,<br>–       client_pv AS <code>client_pv</code>,<br>–       order_hll AS <code>order_hll</code>,<br>        country AS <code>country</code>,<br>–        browser AS <code>browser</code>,<br>–        fx_os AS <code>fx_os</code>,<br>        fx_channel AS <code>fx_channel</code>,<br>–        theme_name AS <code>theme_name</code>,<br>–        payment_method AS <code>payment_method</code>,<br>–        payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>where payment_method &lt;&gt; ‘cod’<br>and event = ‘place_order’) a<br>LEFT JOIN<br>(SELECT distinct<br>created_at,<br>contact,<br>store_id,<br>domain,<br>category,<br>submitter_name,<br>plan,<br>company,<br>state<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) e<br>on a.store_id = e.store_id<br>)<br>)</p>
<h3 id="套餐维度每日收入总和"><a href="#套餐维度每日收入总和" class="headerlink" title="套餐维度每日收入总和"></a>套餐维度每日收入总和</h3><p>– select<br>– date,<br>– sum(total_income)<br>– from<br>– (<br>– select<br>– company,<br>– plan,<br>– date,<br>– sum(total_income) total_income<br>– from<br>– (<br>– select sum(total_income) from<br>select<br>(case when time_interval_plan = ‘monthly-NewProSubscriptionType’ then ‘monthly-ProSubscriptionType’ else time_interval_plan end) plan,<br>time_interval_plan,<br>date,<br>company,<br>ifnull(subscription_sum,0) subscription_sum,<br>ifnull(commission_sum,0) commission_sum,<br>ifnull(subscription_sum,0) + ifnull(commission_sum,0) total_income<br>from<br>(<br>SELECT<br>company,<br>time_interval_plan,<br>date(paid_at) date,<br>sum(price) as subscription_sum<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>group by 1,2,3<br>)<br>full join<br>(<br>SELECT<br>company,<br>plan as time_interval_plan,<br>date(end_time) date,<br>sum(commission_in_usd) as commission_sum<br>FROM  <code>admin-account-293313.KAM.stores_commission__information_xiaoyang</code><br>where commission_paid_state =’paid’<br>group by 1,2,3<br>)<br>using (time_interval_plan,date,company)<br>– )<br>– group by 1,2,3<br>– order by date desc<br>– )<br>– group by 1<br>– order by date desc</p>
<h3 id="sales-续费店铺数据"><a href="#sales-续费店铺数据" class="headerlink" title="sales-续费店铺数据"></a>sales-续费店铺数据</h3><p>– Note: Unless you save your query, these tabs will NOT persist if you clear your cookies or change browsers.<br>select store_id,domain,plan,company,submitter_name,expired_at,date_diff(expired_at,current_date(),day) day_left<br>from<br>admin-account-293313.KAM.stores_information_xiaoyang<br>where date_diff(expired_at,current_date(),day) between 0 and 7</p>
<h3 id="hll-casewhen-notfilter"><a href="#hll-casewhen-notfilter" class="headerlink" title="hll_casewhen_notfilter"></a>hll_casewhen_notfilter</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.usd_total,<br>– a.pageview_ip,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.payment_client,<br>– a.order_count,<br>– a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br>a.country,<br>a.browser,<br>a.fx_os,<br>a.fx_channel,<br>a.theme_name,<br>a.payment_method,<br>a.payment_channel,<br>c.company,<br>d.new_customer,<br>d.new_store,<br>d.created_at,<br>d.domain,<br>d.contact,<br>e.category,<br>e.submitter_name,<br>e.state,<br>plan,<br>(case when e.plan = ‘monthly-NewProSubscriptionType’ then ‘monthly-ProSubscriptionType’ else plan end) plan_pro<br>– ,<br>– b.order_count as <code>count_by_store</code><br>– e.tag<br>FROM<br>(</p>
<p>SELECT date_min AS <code>date_min</code>,<br>      usd_total,<br>      – pageview_ip AS <code>pageview_ip</code>,<br>      – addcart_client AS <code>addcart_client</code>,<br>      – checkout_client AS <code>checkout_client</code>,<br>      – shipping_client AS <code>shipping_client</code>,<br>      – payment_client AS <code>payment_client</code>,<br>      – order_count AS <code>order_count</code>,<br>      – event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      – ip_hll AS <code>ip_hll</code>,<br>      – store_ip_pv AS <code>store_ip_pv</code>,<br>      – client_hll AS <code>client_hll</code>,<br>      – client_pv AS <code>client_pv</code>,<br>      – order_hll AS <code>order_hll</code>,<br>       country AS <code>country</code>,<br>       browser AS <code>browser</code>,<br>       fx_os AS <code>fx_os</code>,<br>       fx_channel AS <code>fx_channel</code>,<br>       theme_name AS <code>theme_name</code>,<br>       payment_method AS <code>payment_method</code>,<br>       payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>where payment_method &lt;&gt; ‘cod’<br>and event = ‘place_order’) a<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code><br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct<br>store_id,<br>new_customer,<br>new_store,<br>domain,<br>contact,<br>created_at<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on a.store_id = d.store_id<br>LEFT JOIN<br>(SELECT distinct<br>store_id,<br>category,<br>submitter_name,<br>state,<br>plan<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) e<br>on a.store_id = e.store_id</p>
<h3 id="sales-转化率敏感数据"><a href="#sales-转化率敏感数据" class="headerlink" title="sales-转化率敏感数据"></a>sales-转化率敏感数据</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.pageview_ip,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.shipping_method_client,<br>– a.payment_client,<br>a.order_count,<br>a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br> a.country,<br>– a.browser,<br>– a.fx_os,<br> a.fx_channel,<br>– a.theme_name,<br>– a.payment_method,<br>– a.payment_channel,<br>c.company,<br>c.submitter_name,<br>d.new_customer,<br>d.new_store,<br>d.created_at<br>– b.order_count as <code>count_by_store</code><br>FROM<br>(SELECT date_min AS <code>date_min</code>,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      – addcart_client AS <code>addcart_client</code>,<br>      – checkout_client AS <code>checkout_client</code>,<br>      – shipping_client AS <code>shipping_client</code>,<br>      – shipping_method_client AS <code>shipping_method_client</code>,<br>      – payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>      event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      – ip_hll AS <code>ip_hll</code>,<br>      – store_ip_pv AS <code>store_ip_pv</code>,<br>      – client_hll AS <code>client_hll</code>,<br>      – client_pv AS <code>client_pv</code>,<br>      – order_hll AS <code>order_hll</code>,<br>       country AS <code>country</code>,<br>      – browser AS <code>browser</code>,<br>      – fx_os AS <code>fx_os</code>,<br>       fx_channel AS <code>fx_channel</code>,<br>      – theme_name AS <code>theme_name</code>,<br>      – payment_method AS <code>payment_method</code>,<br>      – payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code> ) a<br>INNER JOIN<br>(SELECT prc_date AS <code>prc_date</code>,<br>      store_id AS <code>store_id</code>,<br>      order_count AS <code>order_count</code><br>FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>WHERE order_count &gt;10) b<br>on date(a.date_min) = b.prc_date<br>and a.store_id = b.store_id<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code>,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on b.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct store_id,<br>new_customer,<br>new_store,<br>created_at<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on b.store_id = d.store_id</p>
<h3 id="not-filter-hll-casewhen-notfilter-gmv-uv"><a href="#not-filter-hll-casewhen-notfilter-gmv-uv" class="headerlink" title="not_filter_hll_casewhen_notfilter_gmv_uv"></a>not_filter_hll_casewhen_notfilter_gmv_uv</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.online_usd_total,<br>a.pageview_ip,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.payment_client,<br>a.order_count,<br>– a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br>a.country,<br>a.browser,<br>a.fx_os,<br>a.fx_channel,<br>a.theme_name,<br>a.payment_method,<br>a.payment_channel,<br>c.company<br>– ,<br>– d.new_customer,<br>– d.new_store,<br>– d.created_at,<br>– d.domain,<br>– d.contact,<br>– e.category,<br>– e.submitter_name,<br>– e.state,<br>– e.plan<br>– ,<br>– b.order_count as <code>count_by_store</code><br>– e.tag<br>FROM<br>(</p>
<p>SELECT date_min AS <code>date_min</code>,<br>      (case when event = “place_order” and payment_method &lt;&gt;”cod” then usd_total end) as online_usd_total,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      – addcart_client AS <code>addcart_client</code>,<br>      – checkout_client AS <code>checkout_client</code>,<br>      – shipping_client AS <code>shipping_client</code>,<br>      – payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>–       event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      – ip_hll AS <code>ip_hll</code>,<br>      – store_ip_pv AS <code>store_ip_pv</code>,<br>      – client_hll AS <code>client_hll</code>,<br>      – client_pv AS <code>client_pv</code>,<br>      – order_hll AS <code>order_hll</code>,<br>       country AS <code>country</code>,<br>       browser AS <code>browser</code>,<br>       fx_os AS <code>fx_os</code>,<br>       fx_channel AS <code>fx_channel</code>,<br>       theme_name AS <code>theme_name</code>,<br>       payment_method AS <code>payment_method</code>,<br>       payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>where<br>– payment_method &lt;&gt; ‘cod’<br>event in( ‘place_order’,”pageview”)<br>and date_min &gt;= “2021-05-03” and date_min &lt;=”2021-05-07”<br>) a<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code><br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>– LEFT JOIN<br>– (SELECT distinct<br>– store_id,<br>– new_customer,<br>– new_store,<br>– domain,<br>– contact,<br>– created_at<br>– FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>– on a.store_id = d.store_id<br>– LEFT JOIN<br>– (SELECT distinct<br>– store_id,<br>– category,<br>– submitter_name,<br>– state,<br>– plan<br>– FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) e<br>– on a.store_id = e.store_id</p>
<h3 id="hll-casewhen-notfilter-gmv-uv"><a href="#hll-casewhen-notfilter-gmv-uv" class="headerlink" title="hll_casewhen_notfilter_gmv_uv"></a>hll_casewhen_notfilter_gmv_uv</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.online_usd_total,<br>a.pageview_ip,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.payment_client,<br>a.order_count,<br>– a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br>a.country,<br>a.browser,<br>a.fx_os,<br>a.fx_channel,<br>a.theme_name,<br>a.payment_method,<br>a.payment_channel,<br>c.company,<br>b.gmv_uv_tag<br>– ,<br>– d.new_customer,<br>– d.new_store,<br>– d.created_at,<br>– d.domain,<br>– d.contact,<br>– e.category,<br>– e.submitter_name,<br>– e.state,<br>– e.plan<br>– ,<br>– b.order_count as <code>count_by_store</code><br>– e.tag<br>FROM<br>(</p>
<p>SELECT date_min AS <code>date_min</code>,<br>      (case when event = “place_order” and payment_method &lt;&gt;”cod” then usd_total end) as online_usd_total,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      – addcart_client AS <code>addcart_client</code>,<br>      – checkout_client AS <code>checkout_client</code>,<br>      – shipping_client AS <code>shipping_client</code>,<br>      – payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>–       event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      – ip_hll AS <code>ip_hll</code>,<br>      – store_ip_pv AS <code>store_ip_pv</code>,<br>      – client_hll AS <code>client_hll</code>,<br>      – client_pv AS <code>client_pv</code>,<br>      – order_hll AS <code>order_hll</code>,<br>       country AS <code>country</code>,<br>       browser AS <code>browser</code>,<br>       fx_os AS <code>fx_os</code>,<br>       fx_channel AS <code>fx_channel</code>,<br>       theme_name AS <code>theme_name</code>,<br>       payment_method AS <code>payment_method</code>,<br>       payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>where<br>– payment_method &lt;&gt; ‘cod’<br>event in( ‘place_order’,”pageview”)<br>and date_min &gt;= “2021-05-03” and date_min &lt;=”2021-05-07”<br>) a</p>
<p>inner join<br>(SELECT<br>store_id, date, pageview_uv, online_gmv, gmv_uv, order_count, convention_rate ,<br>(case when gmv_uv &gt;= 0 and gmv_uv &lt; 1 then “低客单”<br>when gmv_uv &gt;= 1 and gmv_uv &lt; 2 then “中低客单”<br>when gmv_uv &gt;= 2 and gmv_uv &lt; 3 then “中高客单”<br>else “高客单” end) as gmv_uv_tag</p>
<p>FROM <code>admin-account-293313.Merge_test.daily_store_metric</code><br>– where pageview_uv &gt; 1000<br>where date &gt;= “2021-05-03” and date &lt;=”2021-05-07”</p>
<p>) b<br>on a.store_id = b.store_id<br>and date(a.date_min)= b.date</p>
<p>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code><br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>– LEFT JOIN<br>– (SELECT distinct<br>– store_id,<br>– new_customer,<br>– new_store,<br>– domain,<br>– contact,<br>– created_at<br>– FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>– on a.store_id = d.store_id<br>– LEFT JOIN<br>– (SELECT distinct<br>– store_id,<br>– category,<br>– submitter_name,<br>– state,<br>– plan<br>– FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) e<br>– on a.store_id = e.store_id</p>
<h3 id="online-gmv-store-plan"><a href="#online-gmv-store-plan" class="headerlink" title="online_gmv_store_plan"></a>online_gmv_store_plan</h3><p>select a.store_id, a.date_bj, a.online_gmv ,b.plan<br>from<br>(SELECT store_id, date_bj, online_gmv FROM <code>admin-account-293313.key_table_forBI.store_gmv_all</code>) a<br>left join<br>(select store_id,plan from <code>admin-account-293313.KAM.stores_information_xiaoyang</code> ) b<br>on a.store_id = b.store_id</p>
<h3 id="PMO"><a href="#PMO" class="headerlink" title="PMO"></a>PMO</h3><p>with t as<br>(<br>select<br>distinct<br>*,<br>date_diff(date_max,created_date,day) as days_passed<br>from<br>(SELECT<br>date(time) prc_date,<br>id,<br>key,<br>project,<br>issue_type,<br>state,<br>first_value(state) over(partition by id order by time desc) as final_state,<br>– first_value(state) over(partition by id order by time) as state,<br>date(first_value(time) over(partition by key order by time)) as created_date,<br>date(first_value(time) over(partition by key order by time desc)) as date_max,<br>first_value(team) over(partition by id order by time desc) as team,<br>first_value(source) over(partition by id order by time desc) as source,<br>first_value(demand_type) over(partition by id order by time desc) as demand_type,<br>first_value(platform) over(partition by id order by time desc) as platform,<br>first_value(reporter) over(partition by id order by time desc) as reporter,<br>first_value(operation_env) over(partition by id order by time desc) as operation_env,<br>first_value(priority) over(partition by id order by time desc) as priority<br>FROM <code>admin-account-293313.PMO.jira_task_data</code>)<br>where key not in (select key from <code>admin-account-293313.PMO.jira_task_data</code> where deleted = true )<br>)</p>
<p>select<br>prc_date,<br>team,<br>sum(p0_request_completed) as p0_request_completed, –P0 需求完成数<br>sum(p1_request_completed) as p1_request_completed, –P1 需求完成数<br>sum(p2_request_completed) as p2_request_completed, –P2 需求完成数<br>sum(p0_days_request_completed) as p0_days_request_completed, –P0 需求完成天数<br>sum(p1_days_request_completed) as p1_days_request_completed, –P1 需求完成天数<br>sum(p2_days_request_completed) as p2_days_request_completed, –P2 需求完成天数<br>sum(p0_request_completed_in21days) as p0_request_completed_in21days, –P0 21天完成天数<br>sum(story_completed) as story_completed, –故事完成数<br>sum(request_created_intotal) as request_created_intotal, –新增需求数<br>sum(request_completed_intotal) request_completed_intotal, –需求完成数<br>sum(bug_created_intotal) bug_created_intotal,<br>sum(bug_fixed_intotal) bug_fixed_intotal,<br>sum(p0_bug_fixed) p0_bug_fixed,<br>sum(p1_bug_fixed) p1_bug_fixed,<br>sum(p2_bug_fixed) p2_bug_fixed,<br>sum(p0_days_bug_fixed) p0_days_bug_fixed,<br>sum(p1_days_bug_fixed) p1_days_bug_fixed,<br>sum(p2_days_bug_fixed) p2_days_bug_fixed,<br>sum(p0_bug_fixed_1day) p0_bug_fixed_1day,<br>sum(not_p0_bug_fixed_21day) not_p0_bug_fixed_21day,<br>sum(not_p0_bug_fixed) not_p0_bug_fixed,<br>sum(pre_release_story) pre_release_story,<br>sum(review_story) review_story<br>from<br>(<br>select<br>prc_date,<br>team,<br>– created_date,<br>count(distinct<br>case when issue_type = ‘需求工单’<br>and source = ‘客户’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P0’<br>– and deleted = false<br>then key end) p0_request_completed,</p>
<p>count(distinct<br>case when issue_type = ‘需求工单’<br>and source = ‘客户’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P0’<br>– and deleted = false<br>and days_passed &lt;= 21<br>then key end) p0_request_completed_in21days,</p>
<p>count(distinct<br>case when issue_type = ‘需求工单’<br>and source = ‘客户’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P1’<br>– and deleted = false<br>then key end) p1_request_completed,<br>count(distinct<br>case when issue_type = ‘需求工单’<br>and source = ‘客户’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P2’<br>– and deleted = false<br>then key end) p2_request_completed,<br>sum(<br>case when final_state = ‘已上线’<br>and state = ‘已上线’<br>and issue_type = ‘需求工单’<br>and source = ‘客户’<br>and priority = ‘P0’<br>then days_passed<br>else 0 end<br>) p0_days_request_completed,<br>sum(<br>case when final_state = ‘已上线’<br>and state = ‘已上线’<br>and issue_type = ‘需求工单’<br>and source = ‘客户’<br>and priority = ‘P1’<br>then days_passed<br>else 0 end<br>) p1_days_request_completed,<br>sum(<br>case when final_state = ‘已上线’<br>and state = ‘已上线’<br>and issue_type = ‘需求工单’<br>and source = ‘客户’<br>and  priority = ‘P2’<br>then days_passed<br>else 0 end<br>) p2_days_request_completed,</p>
<p>count(distinct<br>case when issue_type = ‘Story’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>then key end<br>) story_completed,</p>
<p>count( distinct<br>case when issue_type = ‘需求工单’<br>and final_state != ‘已拒绝’<br>and state = ‘待处理’<br>and source = ‘客户’<br>then key end) request_created_intotal,</p>
<p>count( distinct<br>case when issue_type = ‘需求工单’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and source = ‘客户’<br>then key end) request_completed_intotal,</p>
<p>count( distinct<br>case when issue_type = ‘bug工单’<br>and final_state != ‘已拒绝’<br>and state = ‘待处理’<br>and operation_env = ‘线上’<br>then key end) bug_created_intotal,</p>
<p>count( distinct<br>case when issue_type = ‘bug工单’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and operation_env = ‘线上’<br>then key end) bug_fixed_intotal,</p>
<p>count(distinct<br>case when issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P0’<br>then key end) p0_bug_fixed,</p>
<p>count(distinct<br>case when issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P1’<br>then key end) p1_bug_fixed,</p>
<p>count(distinct<br>case when issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P2’<br>then key end) p2_bug_fixed,</p>
<p>sum(<br>case when final_state = ‘已上线’<br>and state = ‘已上线’<br>and issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and priority = ‘P0’<br>then days_passed<br>else 0 end<br>) p0_days_bug_fixed,</p>
<p>sum(<br>case when final_state = ‘已上线’<br>and state = ‘已上线’<br>and issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and priority = ‘P1’<br>then days_passed<br>else 0 end<br>) p1_days_bug_fixed,</p>
<p>sum(<br>case when final_state = ‘已上线’<br>and state = ‘已上线’<br>and issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and  priority = ‘P2’<br>then days_passed<br>else 0 end<br>) p2_days_bug_fixed,</p>
<p>count(distinct<br>case when issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority = ‘P0’<br>and days_passed &lt;= 1<br>then key end) p0_bug_fixed_1day,</p>
<p>count(distinct<br>case when issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority != ‘P0’<br>and days_passed &lt;= 21<br>then key end) not_p0_bug_fixed_21day,</p>
<p>count(distinct<br>case when issue_type = ‘bug工单’<br>and operation_env = ‘线上’<br>and final_state = ‘已上线’<br>and state = ‘已上线’<br>and priority != ‘P0’<br>then key end) not_p0_bug_fixed,</p>
<p>———新增「待发布」用户故事数<br>count(distinct<br>case when issue_type = ‘Story’<br>and state = ‘待发布’<br>then key end) pre_release_story,</p>
<p>———新增「待评审」用户故事数<br>count(distinct<br>case when issue_type = ‘Story’<br>and state = ‘待评审’<br>then key end)  review_story,</p>
<p>from t<br>group by team,prc_date<br>)<br>group by team,prc_date</p>
<h3 id="hll-not-filter-metric-for-test"><a href="#hll-not-filter-metric-for-test" class="headerlink" title="hll_not_filter_metric_for_test"></a>hll_not_filter_metric_for_test</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.usd_total,<br>a.pageview_ip,<br>a.online_gmv,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.payment_client,<br>a.order_count,<br>– a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br>a.country,<br>a.browser,<br>a.fx_os,<br>a.fx_channel,<br>a.theme_name,<br>– a.payment_method,<br>– a.payment_channel,<br>c.company,<br>– d.new_customer,<br>– d.new_store,<br>d.created_at,<br>d.domain,<br>d.contact<br>– ,<br>– e.category,<br>– e.submitter_name,<br>– e.state,<br>– e.plan,<br>– b.order_count as <code>count_by_store</code><br>– e.tag<br>FROM<br>(</p>
<p>SELECT date_min AS <code>date_min</code>,<br>      usd_total,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      (case when event = “place_order” and payment_method &lt;&gt; ‘cod’ then usd_total end) as online_gmv,<br>      – addcart_client AS <code>addcart_client</code>,<br>      – checkout_client AS <code>checkout_client</code>,<br>      – shipping_client AS <code>shipping_client</code>,<br>      – payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>      – event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      – ip_hll AS <code>ip_hll</code>,<br>      – store_ip_pv AS <code>store_ip_pv</code>,<br>      – client_hll AS <code>client_hll</code>,<br>      – client_pv AS <code>client_pv</code>,<br>      – order_hll AS <code>order_hll</code>,<br>       country AS <code>country</code>,<br>       browser AS <code>browser</code>,<br>       fx_os AS <code>fx_os</code>,<br>       fx_channel AS <code>fx_channel</code>,<br>       theme_name AS <code>theme_name</code><br>      – ,<br>      – payment_method AS <code>payment_method</code>,<br>      – payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>WHERE  event in (‘place_order’,’pageview’)) a<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code><br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct<br>store_id,<br>– new_customer,<br>– new_store,<br>domain,<br>contact,<br>created_at<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on a.store_id = d.store_id<br>– LEFT JOIN<br>– (SELECT distinct<br>– store_id,<br>– category,<br>– submitter_name,<br>– state,<br>– plan<br>– FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) e<br>– on a.store_id = e.store_id</p>
<h3 id="Media-Solutions-google-gmv"><a href="#Media-Solutions-google-gmv" class="headerlink" title="Media_Solutions_google_gmv"></a>Media_Solutions_google_gmv</h3><pre><code>WITH TEMP_HOUR AS (
SELECT 
  DATETIME_TRUNC(created_at, HOUR) AS DATEHOUR,
  ROW_NUMBER() OVER ( PARTITION BY DATETIME_TRUNC(created_at, DAY) ORDER BY created_at DESC) AS ROWNUM
FROM
  `admin-account-293313.media_solutions_dataset.tags_source`
)
SELECT
a.date_min as date_min,
DATE(a.date_min) AS `date`,
DATE_TRUNC(a.date_min, MONTH) AS `month`,
a.usd_total, a.store_id, a.country, c.company,
d.created_at, d.domain, d.contact,
e.google_feed_tag, ga_new,
ads,feed_new,feed_alive_new,oauth,total_new,feed_old,ga_old,total_old,total,total_feed,
total_ga,shopping_new,freelisting_new,feed_alive_old,total_feed_alive,shopping_old,freelisting_old,
free_total,shopping_total,gmc_approved_total,feed_and_new,
(CASE WHEN gmv_online &gt; 1  THEN true ELSE false END) AS active_store
FROM 
  (SELECT date_min AS `date_min`,usd_total,store_id AS `store_id`,country AS `country` 
    FROM `admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin` 
    WHERE payment_method &lt;&gt; 'cod' AND event = 'place_order' AND fx_channel IN ("google","google_ads") AND date_min &lt;= '2021-05-11'
) a
INNER JOIN
(
SELECT DISTINCT store_id,google_feed_tag,ga_new,ads,feed_new,feed_alive_new,oauth,total_new,
      feed_old,ga_old,total_old,total,total_feed,total_ga,shopping_new,freelisting_new,feed_alive_old,
      total_feed_alive,shopping_old,freelisting_old,free_total,shopping_total,gmc_approved_total,feed_and_new 
  FROM `admin-account-293313.google_sheet_schedule.google_feed_using_data_copy` 
) e
    ON a.store_id = e.store_id
LEFT JOIN
  (SELECT store_id,SUM(online_gmv) AS gmv_online FROM `admin-account-293313.key_table_forBI.store_gmv_all` WHERE date_bj &gt; '2021-04-11' AND date_bj &lt; '2021-05-11' GROUP BY store_id) ee 
    ON a.store_id = ee.store_id
LEFT JOIN
  (SELECT distinct store_id AS `store_id`, company AS `company` FROM `admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng`) c
    ON a.store_id = c.store_id 
LEFT JOIN
  (SELECT distinct store_id,domain,contact,created_at FROM `admin-account-293313.KAM.4_storetables_connect_xiaoyang`) d
    ON a.store_id = d.store_id
UNION ALL
(
SELECT
timestamp(e.created_at) AS date_min,
date(e.created_at) AS `date`,
timestamp(DATE_TRUNC(e.created_at, MONTH)) AS `month`,
a.usd_total, a.store_id, a.country, c.company,
d.created_at, d.domain, d.contact,
"" AS google_feed_tag, ga_new,
ads,feed_new,feed_alive_new,oauth,total_new,feed_old,ga_old,total_old,total,total_feed,
total_ga,shopping_new,freelisting_new,feed_alive_old,total_feed_alive,shopping_old,freelisting_old,
free_total,shopping_total,gmc_approved_total,feed_and_new,
is_active AS active_store
FROM `admin-account-293313.media_solutions_dataset.tags_source` AS e
LEFT JOIN 
  (SELECT date_min AS `date_min`,usd_total,store_id AS `store_id`,country AS `country`
    FROM `admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin` 
    WHERE payment_method &lt;&gt; 'cod' AND event = 'place_order' AND fx_channel IN ("google","google_ads") AND date_min &gt; '2021-05-11'
) a
    ON a.store_id = e.store_id AND DATE(a.date_min) = DATE(e.created_at)
LEFT JOIN
  (SELECT distinct store_id AS `store_id`, company AS `company` FROM `admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng`) c
    ON a.store_id = c.store_id 
LEFT JOIN
  (SELECT distinct store_id,domain,contact,created_at FROM `admin-account-293313.KAM.4_storetables_connect_xiaoyang`) d
    ON a.store_id = d.store_id
WHERE e.created_at &gt;= '2021-05-11' AND DATETIME_TRUNC(e.created_at, HOUR) IN (SELECT DATEHOUR FROM TEMP_HOUR WHERE ROWNUM = 1)
)</code></pre>
<h3 id="PMO-jira-数据统计"><a href="#PMO-jira-数据统计" class="headerlink" title="PMO-jira_数据统计"></a>PMO-jira_数据统计</h3><p>select *,<br>date_diff(date_max,created_date,day) as days_passed<br>from<br>(SELECT<br>*,<br>first_value(state) over(partition by id order by time desc) as final_state,<br>date(first_value(time) over(partition by key order by time)) as created_date,<br>date(first_value(time) over(partition by key order by time desc)) as date_max<br>FROM <code>admin-account-293313.PMO.jira_task_data</code>)</p>
<h3 id="DMP-B端使用详情"><a href="#DMP-B端使用详情" class="headerlink" title="DMP-B端使用详情"></a>DMP-B端使用详情</h3><p>select<br>store_id,<br>ifnull(utm_source,’other’) as source,<br>created_at<br>from <code>admin-account-293313.KAM.stores_information_xiaoyang</code></p>
<h3 id="sales-店铺信息"><a href="#sales-店铺信息" class="headerlink" title="sales-店铺信息"></a>sales-店铺信息</h3><p>SELECT  * FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code> </p>
<h3 id="Media-Solutions-tags-count"><a href="#Media-Solutions-tags-count" class="headerlink" title="Media_Solutions_tags_count"></a>Media_Solutions_tags_count</h3><p>SELECT tag AS <code>tag</code>,<br>       num AS <code>num</code>,<br>       filter AS <code>filter</code>,<br>       created_at AS <code>created_at</code><br>FROM <code>media_solutions_dataset</code>.<code>tags_count</code></p>
<h3 id="Media-Solutions-suspend-reason"><a href="#Media-Solutions-suspend-reason" class="headerlink" title="Media_Solutions_suspend_reason"></a>Media_Solutions_suspend_reason</h3><p>SELECT title AS <code>title</code>,<br>       detail AS <code>detail</code>,<br>       servability AS <code>servability</code>,<br>       num AS <code>num</code>,<br>       attribute AS <code>attribute</code>,<br>       created_at AS <code>created_at</code>,<br>       is_account_level_issues AS <code>is_account_level_issues</code>,<br>       version AS <code>version</code><br>FROM <code>media_solutions_dataset</code>.<code>suspend_reason</code></p>
<h3 id="Media-Solutions-google-merchant-status"><a href="#Media-Solutions-google-merchant-status" class="headerlink" title="Media_Solutions_google_merchant_status"></a>Media_Solutions_google_merchant_status</h3><p>SELECT store_id AS <code>store_id</code>,<br>       merchant_id AS <code>merchant_id</code>,<br>       gmc_shopping AS <code>gmc_shopping</code>,<br>       gmc_free_listing AS <code>gmc_free_listing</code>,<br>       products_submitted AS <code>products_submitted</code>,<br>       products_active AS <code>products_active</code>,<br>       products_disapproved AS <code>products_disapproved</code>,<br>       products_pending AS <code>products_pending</code>,<br>       approve_rate AS <code>approve_rate</code>,<br>       version AS <code>version</code>,<br>                  is_ads_customer AS <code>is_ads_customer</code>,<br>                  created_at AS <code>created_at</code>,<br>                  is_active AS <code>is_active</code><br>FROM <code>media_solutions_dataset</code>.<code>google_merchant_status</code></p>
<h3 id="Media-Solutions-tags-source"><a href="#Media-Solutions-tags-source" class="headerlink" title="Media_Solutions_tags_source"></a>Media_Solutions_tags_source</h3><p>SELECT store_id AS <code>store_id</code>,<br>       created_at AS <code>created_at</code>,<br>       tags AS <code>tags</code>,<br>       ga_new AS <code>ga_new</code>,<br>       ads AS <code>ads</code>,<br>       feed_new AS <code>feed_new</code>,<br>       feed_alive_new AS <code>feed_alive_new</code>,<br>       oauth AS <code>oauth</code>,<br>       total_new AS <code>total_new</code>,<br>       feed_old AS <code>feed_old</code>,<br>       ga_old AS <code>ga_old</code>,<br>       total_old AS <code>total_old</code>,<br>       total AS <code>total</code>,<br>       total_feed AS <code>total_feed</code>,<br>       total_ga AS <code>total_ga</code>,<br>       shopping_new AS <code>shopping_new</code>,<br>       freelisting_new AS <code>freelisting_new</code>,<br>       feed_alive_old AS <code>feed_alive_old</code>,<br>       total_feed_alive AS <code>total_feed_alive</code>,<br>       shopping_old AS <code>shopping_old</code>,<br>       freelisting_old AS <code>freelisting_old</code>,<br>       free_total AS <code>free_total</code>,<br>       shopping_total AS <code>shopping_total</code>,<br>       gmc_approved_total AS <code>gmc_approved_total</code>,<br>       feed_and_new AS <code>feed_and_new</code>,<br>       is_active AS <code>is_active</code><br>FROM <code>media_solutions_dataset</code>.<code>tags_source</code></p>
<h3 id="product-钟舒欣"><a href="#product-钟舒欣" class="headerlink" title="product-钟舒欣"></a>product-钟舒欣</h3><p>SELECT distinct<br>store_id,<br>payment_channel,<br>merchant_id,<br>datetime(time,’Asia/Shanghai’) as prc_date,<br>state,<br>expired_at<br>FROM <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>join<br>(SELECT store_id,state,expired_at FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code> where internal = 0)<br>using(store_id)<br>where time &gt;= ‘2021-01-01’<br>and platform = ‘shop’<br>and event = ‘place_order’<br>order by store_id</p>
<h3 id="FE-events-all-event-distinct-clientid"><a href="#FE-events-all-event-distinct-clientid" class="headerlink" title="FE_events_all_event_distinct_clientid"></a>FE_events_all_event_distinct_clientid</h3><p>select date_bjt,<br>min(case when event=’$pageview’ then uv else null end) pageview_clientid,<br>min(case when event=’add_to_cart’ then uv else null end) addcart_clientid,<br>min(case when event=’begin_checkout’ then uv else null end) checkout_clientid,<br>min(case when event=’set_shipping_address’ then uv else null end) shipping_address_clientid,<br>min(case when event=’add_shipping_method’ then uv else null end) shipping_method_clientid,<br>min(case when event=’add_payment_info’ then uv else null end) payment_clientid,<br>min(case when event=’purchase’ then uv else null end) purchase_clientid,<br>min(case when event=’place_order’ then uv else null end) place_order_clientid,<br>FROM<br>(SELECT date_bjt AS <code>date_bjt</code>,<br>       event AS <code>event</code>,<br>       uv AS <code>uv</code><br>FROM  <code>admin-account-293313.BI.FE_events_all_event_distinct_clientid</code> )<br>group by date_bjt</p>
<h3 id="sensitive-data-总转化率-trend"><a href="#sensitive-data-总转化率-trend" class="headerlink" title="sensitive_data_总转化率_trend"></a>sensitive_data_总转化率_trend</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.pageview_ip,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.shipping_method_client,<br>– a.payment_client,<br>a.order_count,<br>a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br>– a.country,<br>– a.browser,<br>– a.fx_os,<br>– a.fx_channel,<br>– a.theme_name,<br>– a.payment_method,<br>– a.payment_channel,<br>c.company,<br>c.submitter_name,<br>d.created_at<br>– b.order_count as <code>count_by_store</code><br>FROM<br>(SELECT date_min AS <code>date_min</code>,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      – addcart_client AS <code>addcart_client</code>,<br>      – checkout_client AS <code>checkout_client</code>,<br>      – shipping_client AS <code>shipping_client</code>,<br>      – shipping_method_client AS <code>shipping_method_client</code>,<br>      – payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>      event AS <code>event</code>,<br>      store_id AS <code>store_id</code><br>      – ip_hll AS <code>ip_hll</code>,<br>      – store_ip_pv AS <code>store_ip_pv</code>,<br>      – client_hll AS <code>client_hll</code>,<br>      – client_pv AS <code>client_pv</code>,<br>      – order_hll AS <code>order_hll</code>,<br>      – country AS <code>country</code>,<br>      – browser AS <code>browser</code>,<br>      – fx_os AS <code>fx_os</code>,<br>      – fx_channel AS <code>fx_channel</code>,<br>      – theme_name AS <code>theme_name</code>,<br>      – payment_method AS <code>payment_method</code>,<br>      – payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code> ) a<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code>,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct store_id,<br>created_at<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on a.store_id = d.store_id</p>
<h3 id="sensitive-data-总转化率"><a href="#sensitive-data-总转化率" class="headerlink" title="sensitive_data_总转化率"></a>sensitive_data_总转化率</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.pageview_ip,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.shipping_method_client,<br>– a.payment_client,<br>a.order_count,<br>a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br>– a.country,<br>– a.browser,<br>– a.fx_os,<br>– a.fx_channel,<br>– a.theme_name,<br>– a.payment_method,<br>– a.payment_channel,<br>c.company,<br>c.submitter_name,<br>d.created_at<br>– b.order_count as <code>count_by_store</code><br>FROM<br>(SELECT date_min AS <code>date_min</code>,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      – addcart_client AS <code>addcart_client</code>,<br>      – checkout_client AS <code>checkout_client</code>,<br>      – shipping_client AS <code>shipping_client</code>,<br>      – shipping_method_client AS <code>shipping_method_client</code>,<br>      – payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>      event AS <code>event</code>,<br>      store_id AS <code>store_id</code><br>      – ip_hll AS <code>ip_hll</code>,<br>      – store_ip_pv AS <code>store_ip_pv</code>,<br>      – client_hll AS <code>client_hll</code>,<br>      – client_pv AS <code>client_pv</code>,<br>      – order_hll AS <code>order_hll</code>,<br>      – country AS <code>country</code>,<br>      – browser AS <code>browser</code>,<br>      – fx_os AS <code>fx_os</code>,<br>      – fx_channel AS <code>fx_channel</code>,<br>      – theme_name AS <code>theme_name</code>,<br>      – payment_method AS <code>payment_method</code>,<br>      – payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code> ) a<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code>,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct store_id,<br>created_at<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on a.store_id = d.store_id</p>
<h3 id="sales-BD月环比"><a href="#sales-BD月环比" class="headerlink" title="sales-BD月环比"></a>sales-BD月环比</h3><p>select<br>t1.submitter_name,<br>t1.month as previous_month,<br>t2.month,<br>round(t1.subscription_fee,2) as previous_achivement,<br>round(t2.subscription_fee,2) as achivement,<br>round(ieee_divide((t2.subscription_fee-t1.subscription_fee),t1.subscription_fee),2) as growth_over_month<br>from<br>(<br>SELECT<br>sum(price) as subscription_fee,<br>date_trunc(paid_at,month) month,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>where submitter_name is not null<br>group by submitter_name,month<br>)t1</p>
<p>join </p>
<p>(<br>SELECT<br>sum(price) as subscription_fee,<br>date_trunc(paid_at,month) month,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>where submitter_name is not null<br>group by submitter_name,month<br>) t2</p>
<p>on t1.submitter_name = t2.submitter_name<br>and t1.month = date_sub(t2.month, interval 1 month)</p>
<p>– select<br>– t1.submitter_name,<br>– t1.month as previous_month,<br>– t2.month,<br>– t1.subscription_fee as previous_achivement,<br>– t2.subscription_fee as achivement,<br>– ieee_divide((t2.subscription_fee-t1.subscription_fee),t1.subscription_fee) as growth_over_month<br>– from table t1<br>– join table t2<br>– on t1.submitter_name = t2.submitter_name<br>– and t1.month = date_sub(t2.month, interval 1 month)<br>– from<br>– (SELECT<br>– sum(price) as subscription_fee,<br>– date_trunc(paid_at,month) month,<br>– submitter_name<br>– FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>– where submitter_name is not null<br>– group by submitter_name,month) table</p>
<h3 id="sensitive-data-gmv"><a href="#sensitive-data-gmv" class="headerlink" title="sensitive_data_gmv"></a>sensitive_data_gmv</h3><p>select<br>a.store_id,<br>b.domain,<br>b.primary_domain,<br>b.contact,<br>a.date_bj,<br>a.gmv_online,<br>b.company,<br>b.submitter_name<br>FROM<br>(SELECT store_id AS <code>store_id</code>,<br>       date_bj AS <code>date_bj</code>,<br>       gmv_online AS <code>gmv_online</code><br>FROM <code>key_table_forBI</code>.<code>store_gmv_all</code>) a<br>LEFT JOIN<br>(SELECT distinct<br>store_id,<br>company,<br>domain,<br>primary_domain,<br>contact,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) b<br>on a.store_id = b.store_id</p>
<h3 id="sensitive-data-gmv-trend"><a href="#sensitive-data-gmv-trend" class="headerlink" title="sensitive_data_gmv_trend"></a>sensitive_data_gmv_trend</h3><p>select<br>a.store_id,<br>a.date_bj,<br>a.gmv_online,<br>b.company,<br>b.submitter_name<br>FROM<br>(SELECT store_id AS <code>store_id</code>,<br>       date_bj AS <code>date_bj</code>,<br>       gmv_online AS <code>gmv_online</code><br>FROM <code>key_table_forBI</code>.<code>store_gmv_all</code>) a<br>LEFT JOIN<br>(SELECT distinct<br>store_id,<br>company,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) b<br>on a.store_id = b.store_id</p>
<h3 id="Merchant-Success—stores-dispute"><a href="#Merchant-Success—stores-dispute" class="headerlink" title="Merchant Success—stores_dispute"></a>Merchant Success—stores_dispute</h3><p>SELECT store_id AS <code>store_id</code>,<br>      – email AS <code>email</code>,<br>      – created_at AS <code>created_at</code>,<br>       company AS <code>company</code>,<br>      – state AS <code>state</code>,<br>      – submitter_name AS <code>submitter_name</code>,<br>       domain AS <code>domain</code>,<br>       primary_domain AS <code>primary_domain</code>,<br>      – gmv_7 AS <code>gmv_7</code>,<br>      – gmv_60 AS <code>gmv_60</code>,<br>       gmv_30 AS <code>gmv_30</code>,<br>      – order_count AS <code>order_count</code>,<br>      – dispute_order_count AS <code>dispute_order_count</code>,<br>       dispute_rate_by_count AS <code>dispute_rate_by_count</code>,<br>       gmv_amount AS <code>gmv_amount</code>,<br>       dispute_gmv_amount AS <code>dispute_gmv_amount</code>,<br>       dispute_rate_by_amount AS <code>dispute_rate_by_amount</code>,<br>       dispute_gmv_amount_60 AS <code>dispute_gmv_amount_60</code>,<br>      – MERCHANDISE_OR_SERVICE_NOT_AS_DESCRIBED AS <code>MERCHANDISE_OR_SERVICE_NOT_AS_DESCRIBED</code>,<br>      – MERCHANDISE_OR_SERVICE_NOT_RECEIVED AS <code>MERCHANDISE_OR_SERVICE_NOT_RECEIVED</code>,<br>      – UNAUTHORISED AS <code>UNAUTHORISED</code>,<br>      – notdiscribed_rate AS <code>notdiscribed_rate</code>,<br>      – notreceived_rate AS <code>notreceived_rate</code>,<br>      – unauthorised_rate AS <code>unauthorised_rate</code>,<br>      – product_title AS <code>product_title</code>,<br>      – sales_count_max AS <code>sales_count_max</code>,<br>      – product_url AS <code>product_url</code>,<br>      – MERCHANDISE_OR_SERVICE_NOT_AS_DESCRIBED_60 AS <code>MERCHANDISE_OR_SERVICE_NOT_AS_DESCRIBED_60</code>,<br>      – MERCHANDISE_OR_SERVICE_NOT_RECEIVED_60 AS <code>MERCHANDISE_OR_SERVICE_NOT_RECEIVED_60</code>,<br>      – notdiscribed_rate_60 AS <code>notdiscribed_rate_60</code>,<br>      – notreceived_rate_60 AS <code>notreceived_rate_60</code><br>FROM <code>admin-account-293313.key_table_forBI.stores_dispute</code></p>
<h3 id="Theme-转化率相关"><a href="#Theme-转化率相关" class="headerlink" title="Theme-转化率相关"></a>Theme-转化率相关</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>a.pageview_ip,<br>a.addcart_client,<br>a.checkout_client,<br>a.shipping_client,<br>a.shipping_method_client,<br>a.payment_client,<br>a.order_count,<br>a.event,<br>a.store_id,<br>a.ip_hll,<br>a.store_ip_pv,<br>a.client_hll,<br>a.client_pv,<br>a.order_hll,<br>a.country,<br>a.browser,<br>a.fx_os,<br>a.fx_channel,<br>a.theme_name,<br>a.payment_method,<br>a.payment_channel,<br>– c.company,<br>– c.submitter_name,<br>– d.new_customer,<br>– d.new_store,<br>– d.created_at<br>– b.order_count as <code>count_by_store</code><br>FROM<br>(SELECT date_min AS <code>date_min</code>,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      addcart_client AS <code>addcart_client</code>,<br>      checkout_client AS <code>checkout_client</code>,<br>      shipping_client AS <code>shipping_client</code>,<br>      shipping_method_client AS <code>shipping_method_client</code>,<br>      payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>      event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      ip_hll AS <code>ip_hll</code>,<br>      store_ip_pv AS <code>store_ip_pv</code>,<br>      client_hll AS <code>client_hll</code>,<br>      client_pv AS <code>client_pv</code>,<br>      order_hll AS <code>order_hll</code>,<br>      country AS <code>country</code>,<br>      browser AS <code>browser</code>,<br>      fx_os AS <code>fx_os</code>,<br>      fx_channel AS <code>fx_channel</code>,<br>      theme_name AS <code>theme_name</code>,<br>      payment_method AS <code>payment_method</code>,<br>      payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code> ) a<br>INNER JOIN<br>(SELECT prc_date AS <code>prc_date</code>,<br>      store_id AS <code>store_id</code>,<br>      order_count AS <code>order_count</code><br>FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>WHERE order_count &gt;10) b<br>on date(a.date_min) = b.prc_date<br>and a.store_id = b.store_id<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code>,<br>submitter_name<br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on b.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct store_id,<br>new_customer,<br>new_store,<br>created_at<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on b.store_id = d.store_id</p>
<h3 id="Theme-订单相关"><a href="#Theme-订单相关" class="headerlink" title="Theme-订单相关"></a>Theme-订单相关</h3><p>SELECT<br>a.date_min,<br>date(a.date_min) as <code>date</code>,<br>– a.usd_total,<br>– a.pageview_ip,<br>– a.addcart_client,<br>– a.checkout_client,<br>– a.shipping_client,<br>– a.payment_client,<br>– a.order_count,<br>– a.event,<br>a.store_id,<br>– a.ip_hll,<br>– a.store_ip_pv,<br>– a.client_hll,<br>– a.client_pv,<br>– a.order_hll,<br>a.country,<br>a.browser,<br>a.fx_os,<br>a.fx_channel,<br>a.theme_name,<br>a.payment_method,<br>a.payment_channel,<br>– c.company,<br>– d.new_customer,<br>– d.new_store,<br>– d.created_at,<br>– d.domain,<br>– d.contact,<br>– e.category,<br>– e.submitter_name,<br>– e.state<br>– ,<br>– b.order_count as <code>count_by_store</code><br>– e.tag<br>FROM<br>(</p>
<p>SELECT date_min AS <code>date_min</code>,<br>      usd_total,<br>      pageview_ip AS <code>pageview_ip</code>,<br>      addcart_client AS <code>addcart_client</code>,<br>      checkout_client AS <code>checkout_client</code>,<br>      shipping_client AS <code>shipping_client</code>,<br>      payment_client AS <code>payment_client</code>,<br>      order_count AS <code>order_count</code>,<br>      event AS <code>event</code>,<br>      store_id AS <code>store_id</code>,<br>      ip_hll AS <code>ip_hll</code>,<br>      store_ip_pv AS <code>store_ip_pv</code>,<br>      client_hll AS <code>client_hll</code>,<br>      client_pv AS <code>client_pv</code>,<br>      order_hll AS <code>order_hll</code>,<br>       country AS <code>country</code>,<br>       browser AS <code>browser</code>,<br>       fx_os AS <code>fx_os</code>,<br>       fx_channel AS <code>fx_channel</code>,<br>       theme_name AS <code>theme_name</code>,<br>       payment_method AS <code>payment_method</code>,<br>       payment_channel AS <code>payment_channel</code><br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>where payment_method &lt;&gt; ‘cod’<br>and event = ‘place_order’) a<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code><br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on a.store_id = c.store_id<br>LEFT JOIN<br>(SELECT distinct<br>store_id,<br>new_customer,<br>new_store,<br>domain,<br>contact,<br>created_at<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code>) d<br>on a.store_id = d.store_id<br>LEFT JOIN<br>(SELECT distinct<br>store_id,<br>category,<br>submitter_name,<br>state<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code>) e<br>on a.store_id = e.store_id</p>
<h3 id="sales-店铺抽佣信息"><a href="#sales-店铺抽佣信息" class="headerlink" title="sales-店铺抽佣信息"></a>sales-店铺抽佣信息</h3><p>SELECT store_id, domain, contact, commission_in_usd, paid_month, company, submitter_name, commission_paid_state, end_time, try_count,card_brand,card_last4<br>FROM <code>admin-account-293313.KAM.stores_commission__information_xiaoyang</code><br>where company is not null</p>
<h3 id="product-loading-time-group-by天"><a href="#product-loading-time-group-by天" class="headerlink" title="product-loading_time(group by天)"></a>product-loading_time(group by天)</h3><p>SELECT<br>distinct<br>prc_date,<br>PERCENTILE_cont(first_contentful_paint,0.90) over(partition by prc_date) loading_90th,<br>PERCENTILE_cont(first_contentful_paint,0.50) over(partition by prc_date) loading_50th,<br>avg(first_contentful_paint) over(partition by prc_date,os,country) loading_avg<br>FROM <code>admin-account-293313.hour_TEST_xiaoyang_.product-url_first_content</code> </p>
<p>– (select prc_date,avg(first_contentful_paint) FROM <code>admin-account-293313.hour_TEST_xiaoyang_.product-url_first_content</code> group by prc_date order by prc_date)</p>
<h3 id="product-loading-time"><a href="#product-loading-time" class="headerlink" title="product-loading_time"></a>product-loading_time</h3><p>SELECT<br>distinct<br>prc_date,<br>os,<br>country,<br>PERCENTILE_cont(first_contentful_paint,0.90) over(partition by prc_date,os,country) loading_90th,<br>PERCENTILE_cont(first_contentful_paint,0.50) over(partition by prc_date,os,country) loading_50th,<br>avg(first_contentful_paint) over(partition by prc_date,os,country) loading_avg<br>FROM <code>admin-account-293313.hour_TEST_xiaoyang_.product-url_first_content</code> </p>
<p>– (select prc_date,avg(first_contentful_paint) FROM <code>admin-account-293313.hour_TEST_xiaoyang_.product-url_first_content</code> group by prc_date order by prc_date)</p>
<h3 id="Product-Q1指标分位"><a href="#Product-Q1指标分位" class="headerlink" title="Product-Q1指标分位"></a>Product-Q1指标分位</h3><p>with uv_table as<br>(<br>  SELECT<br>    store_id,<br>    APPROX_COUNT_DISTINCT(concat(store_id,”&amp;”,_ip)) ip_num,<br>    date(time,’Asia/Shanghai’) as prc_date,</p>
<p>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>  event = ‘pageview’<br>  and platform = ‘shop’<br>  and time &gt; ‘2020-12-31 16:00:00’<br>  GROUP BY<br>    store_id,<br>    prc_date<br>)<br>,<br>order_table as<br>(<br>  SELECT<br>    store_id,<br>    APPROX_COUNT_DISTINCT(order_id) order_num,  – 订单量<br>    date(time,’Asia/Shanghai’) as prc_date<br>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>  event = ‘place_order’<br>  AND platform = ‘shop’<br>  AND payment_method != ‘cod’<br>  and time &gt; ‘2020-12-31 16:00:00’</p>
<p>  GROUP BY<br>    store_id,<br>    prc_date<br>)<br>,<br>addcart_table as<br>(<br>  SELECT<br>    store_id,<br>    APPROX_COUNT_DISTINCT(client_id) addcart_num,  – 订单量<br>    date(time,’Asia/Shanghai’) as prc_date<br>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>  event = ‘add_to_cart’<br>  AND platform = ‘shop’<br>  and time &gt; ‘2020-12-31 16:00:00’</p>
<p>  GROUP BY<br>    store_id,<br>    prc_date<br>)</p>
<p>select<br>prc_date,<br>– store_id,<br>– ip_num,<br>– order_num,<br>IEEE_DIVIDE(sum(addcart_num),sum(ip_num)) as addcart_rate,<br>IEEE_DIVIDE(sum(order_num),sum(ip_num)) as convention_rate</p>
<p>– PERCENTILE_cont((IEEE_DIVIDE(sum(addcart_num),sum(ip_num))),0.5) over(partition by prc_date) as addcart_rate_50th,<br>– PERCENTILE_cont((IEEE_DIVIDE(sum(order_num),sum(ip_num))),0.5) over(partition by prc_date) as convention_rate_50th,</p>
<p>from uv_table<br>join<br>order_table<br>using(store_id,prc_date)<br>join<br>(<br>SELECT<br>prc_date,<br>store_id<br>FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>where order_count &gt; 10<br>)<br>using(prc_date,store_id)<br>join<br>addcart_table<br>using (store_id,prc_date)<br>group by prc_date</p>
<h3 id="product-首页加载时间（清洗后）"><a href="#product-首页加载时间（清洗后）" class="headerlink" title="product-首页加载时间（清洗后）"></a>product-首页加载时间（清洗后）</h3><p>select *<br>from <code>admin-account-293313.hour_TEST_xiaoyang_.product-url_first_content</code><br>join<br>(<br>SELECT<br>distinct<br>prc_date,<br>PERCENTILE_CONT(first_contentful_paint,0.95) over (partition by prc_date) fcp_95tp<br>FROM <code>admin-account-293313.hour_TEST_xiaoyang_.product-url_first_content</code><br>)<br>using (prc_date)<br>where  first_contentful_paint &lt; fcp_95tp<br>and first_contentful_paint &gt; 0</p>
<h3 id="new-store-usd-xiaoyang"><a href="#new-store-usd-xiaoyang" class="headerlink" title="new_store_usd_xiaoyang"></a>new_store_usd_xiaoyang</h3><p>select<br>store_id,<br>company,<br>prc_date,<br>new_store,<br>plan_usd,<br>commission_usd<br>from<br>(<br>SELECT<br>store_id,<br>company,<br>date(paid_at) as prc_date,<br>new_store,<br>sum((case when currency = ‘RMB’ then price/6.5 else price end)) as plan_usd,<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>group by<br>store_id,<br>company,<br>prc_date,<br>time_interval_plan,<br>new_store<br>) plan_table<br>full join<br>(<br>select<br>store_id,<br>company,<br>date(end_time) as prc_date,<br>new_store,<br>sum(commission_in_usd) as commission_usd<br>FROM <code>admin-account-293313.KAM.stores_commission__information_xiaoyang</code><br>where  commission_paid_state = ‘paid’<br>group by<br>store_id,<br>company,<br>prc_date,<br>new_store<br>) commission_table<br>using (prc_date,store_id,company,new_store)</p>
<h3 id="strategy-流失率相关"><a href="#strategy-流失率相关" class="headerlink" title="strategy-流失率相关"></a>strategy-流失率相关</h3><p>with churn_table as<br>(<br>SELECT<br>date(expired_at) as prc_date,<br>price,<br>store_id<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code><br>where state = ‘expired’<br>and date(expired_at) &gt;= ‘2020-10-01’<br>and date(expired_at) &lt;= date(current_datetime(‘Asia/Shanghai’))</p>
<p>)</p>
<p>,created_store_table as<br>(<br>SELECT<br>date(created_at) as prc_date,<br>– purchase_price,<br>store_id<br>FROM <code>admin-account-293313.KAM.stores_purchase_history_information_xiaoyang</code><br>where created_at &gt;= ‘2020-10-01’<br>)</p>
<p>,revenue_table as<br>(<br>SELECT<br>date(paid_at) as prc_date,<br>purchase_price,<br>– store_id<br>FROM <code>admin-account-293313.KAM.stores_purchase_history_information_xiaoyang</code><br>where paid_at &gt;= ‘2020-10-01’<br>)</p>
<p>select * from<br>(<br>select<br>prc_date,<br>count(distinct store_id) as churned_store_num,<br>sum(price) as churned_revenue,<br>from churn_table<br>group by prc_date<br>)<br>full join </p>
<p>(<br>select<br>prc_date,<br>count(distinct store_id) as created_store_num,<br>– sum(purchase_price) as subscription_revenue,<br>from created_store_table<br>group by prc_date<br>)<br>using(prc_date)<br>full join</p>
<p>(<br>select<br>prc_date,<br>– count(distinct store_id) as created_store_num,<br>sum(purchase_price) as subscription_revenue,<br>from revenue_table<br>group by prc_date<br>)<br>using(prc_date)</p>
<h3 id="compare2day-4metric-notfilter"><a href="#compare2day-4metric-notfilter" class="headerlink" title="compare2day_4metric_notfilter"></a>compare2day_4metric_notfilter</h3><p>– named compare2day_4metric_tongbin<br>  – 使用估算函数，与直接count(distinct *)有出入<br>  – 最近两天同时间段的 独立IP，独立client—_id，订单量， GMV 且 按店铺维度。<br>  – 更改表格为横向，计算delta</p>
<p>SELECT<br>  full_store.store_id,<br>  c.company,</p>
<p>  IFNULL(today_ip_client.today_ip_num,0) AS today_ip_num,<br>  IFNULL(yesterday_ip_client.yesterday_ip_num,0) AS yesterday_ip_num,<br>  IFNULL(today_ip_client.today_ip_num,0)-IFNULL(yesterday_ip_client.yesterday_ip_num,0) as delta_ip,– 今天的独立IP-昨天的独立IP（同时间段）</p>
<p>  IFNULL(today_ip_client.today_client_num,0) AS today_client_num,<br>  IFNULL(yesterday_ip_client.yesterday_client_num,0) AS yesterday_client_num,<br>  IFNULL(today_ip_client.today_client_num,0)-IFNULL(yesterday_ip_client.yesterday_client_num,0) as delta_client,– 今天的独立IP-昨天的独立IP（同时间段）</p>
<p>  IFNULL(today_order.today_order_num,0) AS today_order_num,<br>  IFNULL(yesterday_order.yesterday_order_num,0) AS yesterday_order_num,<br>  IFNULL(today_order.today_order_num,0)-IFNULL(yesterday_order.yesterday_order_num,0) as delta_order_num,</p>
<p>  – 转化率<br>  IFNULL(today_order.today_order_num,0)/today_ip_client.today_ip_num as today_conversion_rate,<br>  IFNULL(yesterday_order.yesterday_order_num,0)/yesterday_ip_client.yesterday_ip_num as yesterday_conversion_rate,<br>  (IFNULL(today_order.today_order_num,0)/today_ip_client.today_ip_num)-(IFNULL(yesterday_order.yesterday_order_num,0)/yesterday_ip_client.yesterday_ip_num) as delta_conversion,</p>
<p>  IFNULL(today_order.today_gmv_sum,0) AS today_gmv_sum,<br>  IFNULL(yesterday_order.yesterday_gmv_sum,0) AS yesterday_gmv_sum,<br>  IFNULL(today_order.today_gmv_sum,0)-IFNULL(yesterday_order.yesterday_gmv_sum,0) as delta_gmv</p>
<p>FROM (<br>  SELECT<br>    store_id,<br>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>    – time &gt;= “2021-03-16 16:00:00”<br>    TIMESTAMP(FORMAT_DATETIME(“%F 16:00:00”,DATETIME_SUB(CURRENT_DATETIME(“Asia/Shanghai”),INTERVAL 2 DAY)))””  –北京时间日期减2天得到的日期拼接16点为起始时间(完整时间区间)<br>    – AND time &lt; “2021-03-18 16:00:00”<br>    TIMESTAMP(CURRENT_DATETIME())  – 记录北京时间截止当天的时间段。逻辑没问题。<br>    –   and event = ‘pageview’ – 全事件记录完整store_id<br>    AND platform = ‘shop’<br>  GROUP BY<br>    store_id) full_store<br>LEFT JOIN<br>(SELECT<br>distinct<br>store_id AS <code>store_id</code>,<br>company AS <code>company</code><br>FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c<br>on full_store.store_id = c.store_id<br>LEFT JOIN (<br>  SELECT<br>    store_id,<br>    APPROX_COUNT_DISTINCT(concat(store_id,”&amp;”,_ip)) today_ip_num,  – 流量ip<br>    APPROX_COUNT_DISTINCT(client_id) today_client_num,  – 流量client_id<br>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>    – time &gt;= “2021-03-17 16:00:00”<br>    TIMESTAMP(FORMAT_DATETIME(“%F 16:00:00”,DATETIME_SUB(CURRENT_DATETIME(“Asia/Shanghai”),INTERVAL 1 DAY)))  –北京时间日期减1天得到的日期拼接16点为起始时间<br>    – AND time &lt; “2021-03-18 16:00:00”<br>    TIMESTAMP(CURRENT_DATETIME())  – 记录北京时间截止当天的时间段。逻辑没问题。<br>    AND event = ‘pageview’<br>    AND platform = ‘shop’<br>  GROUP BY<br>    store_id) today_ip_client<br>ON<br>  full_store.store_id = today_ip_client.store_id<br>LEFT JOIN (<br>  SELECT<br>    store_id,<br>    APPROX_COUNT_DISTINCT(concat(store_id,”&amp;”,_ip)) yesterday_ip_num,   – 流量ip<br>    APPROX_COUNT_DISTINCT(client_id) yesterday_client_num,  – 流量client_id<br>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>    – time &gt;= “2021-03-16 16:00:00”<br>    TIMESTAMP(FORMAT_DATETIME(“%F 16:00:00”,DATE_SUB(DATE(CURRENT_DATETIME(“Asia/Shanghai”)),INTERVAL 2 DAY)))  –北京时间日期减2天得到的日期拼接16点为起始时间<br>    – AND time &lt; “2021-03-17 16:00:00”<br>    TIMESTAMP(DATETIME_SUB(CURRENT_DATETIME(),INTERVAL 24 HOUR)) – 记录前1天截止当前的相同时间段。<br>    AND event = ‘pageview’<br>    AND platform = ‘shop’<br>  GROUP BY<br>    store_id) yesterday_ip_client<br>ON<br>  full_store.store_id = yesterday_ip_client.store_id</p>
<p>– 最近两天同时间段的 订单量、GMV 按店铺维度。</p>
<p>LEFT JOIN (<br>  SELECT<br>    store_id,<br>    APPROX_COUNT_DISTINCT(order_id) today_order_num,  – 订单量<br>    sum(usd_total) today_gmv_sum, – GMV<br>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>    – time &gt;= “2021-03-17 16:00:00”<br>    TIMESTAMP(FORMAT_DATETIME(“%F 16:00:00”,DATETIME_SUB(CURRENT_DATETIME(“Asia/Shanghai”),INTERVAL 1 DAY)))  –北京时间日期减1天得到的日期拼接16点为起始时间<br>    – AND time &lt; “2021-03-18 16:00:00”<br>    TIMESTAMP(CURRENT_DATETIME())  – 记录北京时间截止当天的时间段。逻辑没问题。<br>    AND event = ‘place_order’<br>    AND platform = ‘shop’<br>    AND payment_method != ‘cod’<br>  GROUP BY<br>    store_id) today_order<br>ON<br>  full_store.store_id = today_order.store_id<br>LEFT JOIN (<br>  SELECT<br>    store_id,<br>    APPROX_COUNT_DISTINCT(order_id) yesterday_order_num,  – 订单量<br>    sum(usd_total) yesterday_gmv_sum, – GMV<br>  FROM<br>    <code>central-equinox-282901.shoplaza_analysis.realtime_events</code><br>  WHERE<br>    – time &gt;= “2021-03-16 16:00:00”<br>    TIMESTAMP(FORMAT_DATETIME(“%F 16:00:00”,DATE_SUB(DATE(CURRENT_DATETIME(“Asia/Shanghai”)),INTERVAL 2 DAY)))  –北京时间日期减2天得到的日期拼接16点为起始时间<br>    – AND time &lt; “2021-03-17 16:00:00”<br>    TIMESTAMP(DATETIME_SUB(CURRENT_DATETIME(),INTERVAL 24 HOUR)) – 记录前1天截止当前的相同时间段。<br>    AND event = ‘place_order’<br>    AND platform = ‘shop’<br>    AND payment_method != ‘cod’<br>  GROUP BY<br>    store_id) yesterday_order<br>ON<br>  full_store.store_id = yesterday_order.store_id</p>
<h3 id="两日流量环比"><a href="#两日流量环比" class="headerlink" title="两日流量环比"></a>两日流量环比</h3><p>– Note: Unless you save your query, these tabs will NOT persist if you clear your cookies or change browsers.</p>
<p>select concat(round((today_pg-yesterday_pg)*100/yesterday_pg,2),’%’) as day_over_day<br>FROM<br>  (  –今日下单量<br>SELECT hll_count.merge(pageview_ip) AS <code>today_pg</code><br>FROM<br>  (SELECT a.date_min,<br>          date(a.date_min) as <code>date</code>,<br>          a.pageview_ip,<br>          a.addcart_client,<br>          a.checkout_client,<br>          a.shipping_client,<br>          a.payment_client,<br>          a.order_count,<br>          a.event,<br>          a.store_id,<br>          a.ip_hll,<br>          a.store_ip_pv,<br>          a.client_hll,<br>          a.client_pv,<br>          a.order_hll,<br>          a.country,<br>          a.browser,<br>          a.fx_os,<br>          a.fx_channel,<br>          a.theme_name,<br>          a.payment_method,<br>          a.payment_channel,<br>          c.company,<br>   FROM<br>     (SELECT date_min AS <code>date_min</code>,<br>             pageview_ip AS <code>pageview_ip</code>,<br>             addcart_client AS <code>addcart_client</code>,<br>             checkout_client AS <code>checkout_client</code>,<br>             shipping_client AS <code>shipping_client</code>,<br>             payment_client AS <code>payment_client</code>,<br>             order_count AS <code>order_count</code>,<br>             event AS <code>event</code>,<br>             store_id AS <code>store_id</code>,<br>             ip_hll AS <code>ip_hll</code>,<br>             store_ip_pv AS <code>store_ip_pv</code>,<br>             client_hll AS <code>client_hll</code>,<br>             client_pv AS <code>client_pv</code>,<br>             order_hll AS <code>order_hll</code>,<br>             country AS <code>country</code>,<br>             browser AS <code>browser</code>,<br>             fx_os AS <code>fx_os</code>,<br>             fx_channel AS <code>fx_channel</code>,<br>             theme_name AS <code>theme_name</code>,<br>             payment_method AS <code>payment_method</code>,<br>             payment_channel AS <code>payment_channel</code><br>      FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code>) a<br>   INNER JOIN<br>     (SELECT prc_date AS <code>prc_date</code>,<br>             store_id AS <code>store_id</code>,<br>             order_count AS <code>order_count</code><br>      FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>      WHERE order_count &gt;10) b on date(a.date_min) = b.prc_date<br>   and a.store_id = b.store_id<br>   LEFT JOIN<br>     (SELECT distinct store_id AS <code>store_id</code>,<br>                      company AS <code>company</code><br>      FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id) AS <code>expr_qry</code><br>WHERE <code>date_min</code> &gt;= cast(current_date(‘Asia/Shanghai’) as timestamp)<br>  AND <code>date_min</code> &lt; cast(current_datetime(‘Asia/Shanghai’) as TIMESTAMP)<br>  ) today_orders_table<br>  ,<br>    —————————————————————————————————————-<br>    –昨日下单量<br>  (<br>  SELECT hll_count.merge(pageview_ip) AS <code>yesterday_pg</code><br>  FROM<br>  (SELECT a.date_min,<br>          date(a.date_min) as <code>date</code>,<br>          a.pageview_ip,<br>          a.addcart_client,<br>          a.checkout_client,<br>          a.shipping_client,<br>          a.payment_client,<br>          a.order_count,<br>          a.event,<br>          a.store_id,<br>          a.ip_hll,<br>          a.store_ip_pv,<br>          a.client_hll,<br>          a.client_pv,<br>          a.order_hll,<br>          a.country,<br>          a.browser,<br>          a.fx_os,<br>          a.fx_channel,<br>          a.theme_name,<br>          a.payment_method,<br>          a.payment_channel,<br>          c.company,<br>   FROM<br>     (SELECT date_min AS <code>date_min</code>,<br>             pageview_ip AS <code>pageview_ip</code>,<br>             addcart_client AS <code>addcart_client</code>,<br>             checkout_client AS <code>checkout_client</code>,<br>             shipping_client AS <code>shipping_client</code>,<br>             payment_client AS <code>payment_client</code>,<br>             order_count AS <code>order_count</code>,<br>             event AS <code>event</code>,<br>             store_id AS <code>store_id</code>,<br>             ip_hll AS <code>ip_hll</code>,<br>             store_ip_pv AS <code>store_ip_pv</code>,<br>             client_hll AS <code>client_hll</code>,<br>             client_pv AS <code>client_pv</code>,<br>             order_hll AS <code>order_hll</code>,<br>             country AS <code>country</code>,<br>             browser AS <code>browser</code>,<br>             fx_os AS <code>fx_os</code>,<br>             fx_channel AS <code>fx_channel</code>,<br>             theme_name AS <code>theme_name</code>,<br>             payment_method AS <code>payment_method</code>,<br>             payment_channel AS <code>payment_channel</code><br>      FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code>) a<br>   INNER JOIN<br>     (SELECT prc_date AS <code>prc_date</code>,<br>             store_id AS <code>store_id</code>,<br>             order_count AS <code>order_count</code><br>      FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>      WHERE order_count &gt;10) b on date(a.date_min) = b.prc_date<br>   and a.store_id = b.store_id<br>   LEFT JOIN<br>     (SELECT distinct store_id AS <code>store_id</code>,<br>                      company AS <code>company</code><br>      FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id) AS <code>expr_qry</code><br>WHERE <code>date_min</code> &gt;= cast(date_sub(current_date(‘Asia/Shanghai’),interval 1 day) as timestamp)<br>  AND <code>date_min</code> &lt; cast(datetime_sub(current_datetime(‘Asia/Shanghai’),interval 1 day) as TIMESTAMP)<br>  ) yesterday_orders_table</p>
<h3 id="两日下单量环比"><a href="#两日下单量环比" class="headerlink" title="两日下单量环比"></a>两日下单量环比</h3><p>– Note: Unless you save your query, these tabs will NOT persist if you clear your cookies or change browsers.</p>
<p>select concat(round((today_orders-yesterday_orders)*100/yesterday_orders,2),’%’) as day_over_day</p>
<p>FROM </p>
<p>  (  –今日下单量<br>SELECT hll_count.merge(order_count) AS <code>today_orders</code><br>FROM<br>  (SELECT a.date_min,<br>          date(a.date_min) as <code>date</code>,<br>          a.pageview_ip,<br>          a.addcart_client,<br>          a.checkout_client,<br>          a.shipping_client,<br>          a.payment_client,<br>          a.order_count,<br>          a.event,<br>          a.store_id,<br>          a.ip_hll,<br>          a.store_ip_pv,<br>          a.client_hll,<br>          a.client_pv,<br>          a.order_hll,<br>          a.country,<br>          a.browser,<br>          a.fx_os,<br>          a.fx_channel,<br>          a.theme_name,<br>          a.payment_method,<br>          a.payment_channel,<br>          c.company,<br>   FROM<br>     (SELECT date_min AS <code>date_min</code>,<br>             pageview_ip AS <code>pageview_ip</code>,<br>             addcart_client AS <code>addcart_client</code>,<br>             checkout_client AS <code>checkout_client</code>,<br>             shipping_client AS <code>shipping_client</code>,<br>             payment_client AS <code>payment_client</code>,<br>             order_count AS <code>order_count</code>,<br>             event AS <code>event</code>,<br>             store_id AS <code>store_id</code>,<br>             ip_hll AS <code>ip_hll</code>,<br>             store_ip_pv AS <code>store_ip_pv</code>,<br>             client_hll AS <code>client_hll</code>,<br>             client_pv AS <code>client_pv</code>,<br>             order_hll AS <code>order_hll</code>,<br>             country AS <code>country</code>,<br>             browser AS <code>browser</code>,<br>             fx_os AS <code>fx_os</code>,<br>             fx_channel AS <code>fx_channel</code>,<br>             theme_name AS <code>theme_name</code>,<br>             payment_method AS <code>payment_method</code>,<br>             payment_channel AS <code>payment_channel</code><br>      FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code>) a<br>   INNER JOIN<br>     (SELECT prc_date AS <code>prc_date</code>,<br>             store_id AS <code>store_id</code>,<br>             order_count AS <code>order_count</code><br>      FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>      WHERE order_count &gt;10) b on date(a.date_min) = b.prc_date<br>   and a.store_id = b.store_id<br>   LEFT JOIN<br>     (SELECT distinct store_id AS <code>store_id</code>,<br>                      company AS <code>company</code><br>      FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id) AS <code>expr_qry</code><br>WHERE <code>date_min</code> &gt;= cast(current_date(‘Asia/Shanghai’) as timestamp)<br>  AND <code>date_min</code> &lt; cast(current_datetime(‘Asia/Shanghai’) as TIMESTAMP)<br>  ) today_orders_table<br>  ,<br>    —————————————————————————————————————-<br>    –昨日下单量<br>  (<br>  SELECT hll_count.merge(order_count) AS <code>yesterday_orders</code><br>  FROM<br>  (SELECT a.date_min,<br>          date(a.date_min) as <code>date</code>,<br>          a.pageview_ip,<br>          a.addcart_client,<br>          a.checkout_client,<br>          a.shipping_client,<br>          a.payment_client,<br>          a.order_count,<br>          a.event,<br>          a.store_id,<br>          a.ip_hll,<br>          a.store_ip_pv,<br>          a.client_hll,<br>          a.client_pv,<br>          a.order_hll,<br>          a.country,<br>          a.browser,<br>          a.fx_os,<br>          a.fx_channel,<br>          a.theme_name,<br>          a.payment_method,<br>          a.payment_channel,<br>          c.company,<br>   FROM<br>     (SELECT date_min AS <code>date_min</code>,<br>             pageview_ip AS <code>pageview_ip</code>,<br>             addcart_client AS <code>addcart_client</code>,<br>             checkout_client AS <code>checkout_client</code>,<br>             shipping_client AS <code>shipping_client</code>,<br>             payment_client AS <code>payment_client</code>,<br>             order_count AS <code>order_count</code>,<br>             event AS <code>event</code>,<br>             store_id AS <code>store_id</code>,<br>             ip_hll AS <code>ip_hll</code>,<br>             store_ip_pv AS <code>store_ip_pv</code>,<br>             client_hll AS <code>client_hll</code>,<br>             client_pv AS <code>client_pv</code>,<br>             order_hll AS <code>order_hll</code>,<br>             country AS <code>country</code>,<br>             browser AS <code>browser</code>,<br>             fx_os AS <code>fx_os</code>,<br>             fx_channel AS <code>fx_channel</code>,<br>             theme_name AS <code>theme_name</code>,<br>             payment_method AS <code>payment_method</code>,<br>             payment_channel AS <code>payment_channel</code><br>      FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code>) a<br>   INNER JOIN<br>     (SELECT prc_date AS <code>prc_date</code>,<br>             store_id AS <code>store_id</code>,<br>             order_count AS <code>order_count</code><br>      FROM <code>admin-account-293313.key_table_forBI.store_utc8_order_count</code><br>      WHERE order_count &gt;10) b on date(a.date_min) = b.prc_date<br>   and a.store_id = b.store_id<br>   LEFT JOIN<br>     (SELECT distinct store_id AS <code>store_id</code>,<br>                      company AS <code>company</code><br>      FROM <code>admin-account-293313.KAM.complete_list_union_zhangsen_xiaoayng</code>) c on b.store_id = c.store_id) AS <code>expr_qry</code><br>WHERE <code>date_min</code> &gt;= cast(date_sub(current_date(‘Asia/Shanghai’),interval 1 day) as timestamp)<br>  AND <code>date_min</code> &lt; cast(datetime_sub(current_datetime(‘Asia/Shanghai’),interval 1 day) as TIMESTAMP)<br>  ) yesterday_orders_table</p>
<h3 id="GMV两日环比"><a href="#GMV两日环比" class="headerlink" title="GMV两日环比"></a>GMV两日环比</h3><p>select concat(round((today_gmv-yesterday_gmv)*100/yesterday_gmv,2),’%’) as day_over_day from </p>
<p>–今日的GMV<br>(<br>SELECT sum(usd_total) AS today_gmv<br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>WHERE date_min &gt;= cast(current_date(‘Asia/Shanghai’) as timestamp)<br>  AND date_min &lt; cast(current_datetime(‘Asia/Shanghai’) as TIMESTAMP)<br>  AND payment_method != ‘cod’<br>  AND event = ‘place_order’<br>) today_gmv_table<br>,<br>–昨日的GMV<br>(<br>SELECT sum(usd_total) AS yesterday_gmv<br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>WHERE date_min &gt;= cast(date_sub(current_date(‘Asia/Shanghai’),interval 1 day) as timestamp)<br>  AND date_min &lt; cast(datetime_sub(current_datetime(‘Asia/Shanghai’),interval 1 day) as TIMESTAMP)<br>  AND payment_method != ‘cod’<br>  AND event = ‘place_order’<br>) yesterday_gmv_table</p>
<h3 id="续费次数分布"><a href="#续费次数分布" class="headerlink" title="续费次数分布"></a>续费次数分布</h3><p>– Note: Unless you save your query, these tabs will NOT persist if you clear your cookies or change browsers.</p>
<p>– select purchase_num,<br>– store_id<br>– from<br>– (<br>select<br>store_id,<br>company,<br>– date(paid_at) as paid_at,<br>count(*)-1 as renew_num<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>where price != 0<br>AND  paid_at&gt;=’2020-01-01’<br>– and paid_at &lt; ‘2021-01-01’<br>group by store_id,company<br>– ,paid_at<br>– )</p>
<h3 id="new-store-gmv-xiaoyang"><a href="#new-store-gmv-xiaoyang" class="headerlink" title="new_store_gmv_xiaoyang"></a>new_store_gmv_xiaoyang</h3><p>– select sum(gmv)<br>– from<br>– (<br>select<br>gmv,<br>gmv_table.store_id,<br>new_store,<br>company,<br>prc_date<br>from</p>
<p>(<br>select<br>store_id,<br>date(date_min) as prc_date,<br>sum(usd_total) as gmv<br>FROM <code>admin-account-293313.key_hll_table.hll_mins_PvUvUsd_store_id_0915_utc8_casewhen_tongbin</code><br>where event = ‘place_order’<br>and payment_method != ‘cod’<br>group by<br>store_id,<br>prc_date<br>) gmv_table<br>join<br>(<br>select<br>distinct<br>store_id,<br>new_store,<br>company<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>) new_store_table<br>on gmv_table.store_id  = new_store_table.store_id<br>– )<br>– where prc_date = ‘2021-02-28’</p>
<h3 id="店铺购买次数分布"><a href="#店铺购买次数分布" class="headerlink" title="店铺购买次数分布"></a>店铺购买次数分布</h3><p>– Note: Unless you save your query, these tabs will NOT persist if you clear your cookies or change browsers.</p>
<p>– select purchase_num,<br>– store_id<br>– from<br>– (<br>select<br>store_id,<br>– date(paid_at) as paid_at,<br>count(*) as purchase_num<br>FROM <code>admin-account-293313.KAM.4_storetables_connect_xiaoyang</code><br>where price != 0<br>AND  paid_at&gt;=’2020-01-01’<br>– and paid_at &lt; ‘2021-01-01’<br>group by store_id<br>– ,paid_at<br>– )</p>
<h3 id="流失相关（客户，套餐）"><a href="#流失相关（客户，套餐）" class="headerlink" title="流失相关（客户，套餐）"></a>流失相关（客户，套餐）</h3><p>– Note: Unless you save your query, these tabs will NOT persist if you clear your cookies or change browsers.</p>
<p>SELECT<br>ifnull(company,”N/A”) company,<br>datetime(timestamp(expired_at),’Asia/Shanghai’) expired_at,<br>plan,<br>price,<br>FROM <code>admin-account-293313.KAM.stores_information_xiaoyang</code><br>where internal = 0<br>and datetime(timestamp(expired_at),’Asia/Shanghai’) &lt;= DATE(CURRENT_DATETIME(“Asia/Shanghai”))<br>and state = ‘expired’<br>###</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Nananan</span>
                    </p>
                
                
                    <p class="copyright-item"></p>
                        <span>Post Date:</span>
                        <span>2021-07-21&nbsp;&nbsp;10:13:53</span>
                
                
                    <p class="copyright-item"></p>
                        <span>Update Date:</span>
                        <span>2021-08-04&nbsp;&nbsp;22:03:00</span>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright © 2020 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-sa/4.0/">CC 4.0 BY-SA</a> LICENSE</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://a123wyn.studio/2021/07/21/shoplazza-superset-backup/">http://a123wyn.studio/2021/07/21/shoplazza-superset-backup/</a></span>
                    </p>
                
                <!-- 
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Standing on Shoulders of Giants.</span>
                     </p>
                 -->

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tags:</span>
                <span class="tag">
                    
                    
                        <a href="/tags/work/"># work</a>
                    
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">Back</a>
                <span>· </span>
                <a href="/">Home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/07/29/plugin-demand/">【Shoplazza-plugin_demand】</a>
            
            
                <a class="next" rel="next" href="/2021/05/06/paper/">【毕业设计】学术垃圾的毕业之路杂记</a>
            
        </section>
        
        <!-- gitalk -->
        
            <div id="gitalk-container"></div>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.2/dist/gitalk.css">
<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.2/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: '81e01ebb5ba8cd03bfd3',
        clientSecret: '399d62b6c3e5f29b29178cf5c3ad1407f566d4d2',
        repo: 'a123wyn.github.io',
        owner: 'a123wyn',
        admin: 'a123wyn',
        id: md5(),
        labels: 'Gitalk'.split(',').filter(l => l),
        perPage: '10',
        pagerDirection: 'last',
        createIssueManually: 'true',
        distractionFreeMode: 'true'
      })
      gitalk.render('gitalk-container')
</script>

        
    </article>
</div>

        </div>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="footer">
    <div class="copyright">
        <span>© Nananan | </span>
            <!-- | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a> |  -->
        
            <span id="busuanzi_container_site_uv"><span class="iconfont icon-user"></span><span id="busuanzi_value_site_uv"></span></span>
        
        <!-- 
            <span id="busuanzi_container_site_pv"><span class="iconfont icon-eye"></span><span id="busuanzi_value_site_pv"></span></span>
         -->
    </div>
</footer>

    </div>
</body>
</html>
