DECLARE
  begin_time date;
DECLARE
  end_time date;
SET
  begin_time = '2021-04-01';
SET
  end_time = CURRENT_DATE();
create or replace table `admin-account-293313.DWD.plugin_base_di_c_wyn`
partition by prc_date
cluster by app_name
as
#营销插件的购买
with plugin_purchase as 
(
select
prc_date,
app_name,
ifnull(a.store_id,b.store_id) store_id,
ifnull(a.client_id,b.client_id) client_id,
ifnull(a.country,b.country) country,
ifnull(a.os,b.os) os,
ifnull(a.browser,b.browser) browser,
-- b.fx_channel,
ifnull(a.fx_channel,b.fx_channel) fx_channel,--渠道分类
a.order_id,
b.payment_method,
cast(usd_total as float64) order_total_price,
length(product_ids) product_num
-- cast(num_items as int64) product_num
-- sum(cast(usd_total as float64)) order_total_price, #订单折扣完后的总价
-- json_extract_scalar(od,'$.discount_id') discount_id,
-- count(product_ids) product_num
from
(
select 
date(time,'Asia/Shanghai') prc_date,
app_name,
store_id,
order_id,
client_id,
country,
os,
browser,
CASE WHEN url LIKE '%gclid=%' OR referrer_host LIKE '%gclid=%' THEN 'google_ads'
WHEN referrer_host LIKE '%google.%'
OR latest_referrer_host LIKE '%google.%' THEN 'google'
WHEN referrer_host LIKE '%facebook.%' OR latest_referrer_host LIKE '%facebook.%' OR browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
WHEN referrer_host LIKE '%instagram.%'
OR latest_referrer_host LIKE '%instagram.%'
OR browser = 'Instagram' THEN 'instagram'
WHEN referrer_host LIKE '%pinterest.%' OR latest_referrer_host LIKE '%pinterest.%' OR browser = 'Pinterest' THEN 'pinterest'
WHEN referrer_host LIKE '%snapchat.%'
OR latest_referrer_host LIKE '%snapchat.%'
OR browser = 'Snapchat' THEN 'snapchat'
WHEN user_agent LIKE '%ByteLocale%' OR referrer_host LIKE '%tiktok%.' OR latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
WHEN referrer_host LIKE '%youtube.%'
OR latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
WHEN referrer_host LIKE '%yandex.%' OR latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
WHEN referrer_host LIKE '%yahoo.%'
OR latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
WHEN referrer_host LIKE '%linkedin.%' OR latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
ELSE 'others' END fx_channel,
-- num_items
product_ids
from
(
select
*,
ROW_NUMBER() OVER(PARTITION BY order_id,app_name ORDER BY time DESC) rank_1 #重复数据是解析了product_ids后的数据
from
(
select
id,
time,
case when event = 'plugin_rebate_pv_purchase' then '满减活动'
when event in ('plugin_coupon_pv_purchase') then '优惠码'
when event = 'plugin_flashsale_purchase' then '限时促销'
when event in ('plugin_bundle_combination_atc_purchase','plugin_bundle_combination_click_atc_purchase') then '捆绑销售'
when event in ('crow_combinations_purchase') then '款式组合'
when event = 'plugin_atc_checkout_purchase' then 'Add to Cart 设置'
when event in ('plugin_top_products_purchase','plugin_top_products_indirect_purchase') then '商品置顶'
when event in ('sales_pop_purchase') then '浮窗通知'
when event in ('plugin_discount_reduced_atc_purchase','plugin_discount_present_atc_purchase') then '满送优惠'
when event in ('plugin_recommend_product_purchase') then '自定义推荐'
end app_name,
store_id,
client_id,
country,
os,
browser,
MAX(IF(p.key ='$url',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) url,
MAX(IF(p.key ='$referrer_host',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) referrer_host,
MAX(IF(p.key ='$latest_referrer_host',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) latest_referrer_host,
MAX(IF(p.key ='user_agent',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) user_agent,
max(if(p.key ='order_discount',concat(ifnull(p.string_value,''),ifnull(cast(p.int_value as string),''),ifnull(cast(p.float_value as string),''),ifnull(cast(p.bool_value as string),'')),null)) order_discount,
max(if(p.key ='order_total_price',concat(ifnull(p.string_value,''),ifnull(cast(p.int_value as string),''),ifnull(cast(p.float_value as string),''),ifnull(cast(p.bool_value as string),'')),null)) order_total_price,
max(if(p.key ='order_id',concat(ifnull(p.string_value,''),ifnull(cast(p.int_value as string),''),ifnull(cast(p.float_value as string),''),ifnull(cast(p.bool_value as string),'')),null)) order_id,
max(if(p.key ='discount_total_price',concat(ifnull(p.string_value,''),ifnull(cast(p.int_value as string),''),ifnull(cast(p.float_value as string),''),ifnull(cast(p.bool_value as string),'')),null)) discount_total_price,
-- max(if(p.key ='num_items',concat(ifnull(p.string_value,''),ifnull(cast(p.int_value as string),''),ifnull(cast(p.float_value as string),''),ifnull(cast(p.bool_value as string),'')),null)) num_items
max(if(p.key ='product_ids',concat(ifnull(p.string_value,''),ifnull(cast(p.int_value as string),''),ifnull(cast(p.float_value as string),''),ifnull(cast(p.bool_value as string),'')),null)) product_ids
FROM `shoplaza.shoplaza_analysis.events_all`
left join unnest(properties) p 
WHERE event in ('plugin_rebate_pv_purchase','plugin_coupon_pv_purchase','plugin_flashsale_purchase','plugin_bundle_combination_atc_purchase',
'plugin_bundle_combination_click_atc_purchase','crow_combinations_purchase','plugin_atc_checkout_purchase','plugin_top_products_purchase','plugin_top_products_indirect_purchase',
'sales_pop_purchase','plugin_discount_reduced_atc_purchase','plugin_discount_present_atc_purchase','plugin_recommend_product_purchase')
AND DATE(time,'Asia/Shanghai') BETWEEN begin_time AND end_time
AND store_id IN (
SELECT store_id FROM `admin-account-293313.KAM.stores_information_xiaoyang`
WHERE internal = 0)
group by 1,2,3,4,5,6,7,8
)
)
where rank_1 = 1
)a
#left join realtime_events的order，补全限时促销的client_id，store_id以及country等等字段
left join 
(
select 
* except(time,rank_1)
-- b1.fx_channel
from 
(
-- select 
-- *
-- from
-- (
select 
*,
ROW_NUMBER() OVER(PARTITION BY order_id ORDER BY time DESC) rank_1
from 
(
SELECT 
time,
order_id,
client_id,
country,
_os os,
_browser browser,
CASE WHEN _url LIKE '%gclid=%' OR _referrer_host LIKE '%gclid=%' THEN 'google_ads'
WHEN _referrer_host LIKE '%google.%' OR _latest_referrer_host LIKE '%google.%' THEN 'google'
WHEN _referrer_host LIKE '%facebook.%' OR _latest_referrer_host LIKE '%facebook.%' OR _browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
WHEN _referrer_host LIKE '%instagram.%' OR _latest_referrer_host LIKE '%instagram.%' OR _browser = 'Instagram' THEN 'instagram'
WHEN _referrer_host LIKE '%pinterest.%' OR _latest_referrer_host LIKE '%pinterest.%' OR _browser = 'Pinterest' THEN 'pinterest'
WHEN _referrer_host LIKE '%snapchat.%' OR _latest_referrer_host LIKE '%snapchat.%' OR _browser = 'Snapchat' THEN 'snapchat'
WHEN user_agent LIKE '%ByteLocale%' OR _referrer_host LIKE '%tiktok%.' OR _latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
WHEN _referrer_host LIKE '%youtube.%' OR _latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
WHEN _referrer_host LIKE '%yandex.%' OR _latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
WHEN _referrer_host LIKE '%yahoo.%' OR _latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
WHEN _referrer_host LIKE '%linkedin.%' OR _latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
ELSE 'others' END fx_channel,
store_id,
payment_method,
usd_total
FROM `central-equinox-282901.shoplaza_analysis.realtime_events` 
where event ='place_order'
-- and payment_method !='cod'
-- and platform ='shop'
AND DATE(time,'Asia/Shanghai') BETWEEN begin_time AND end_time
AND store_id IN (
SELECT store_id FROM `admin-account-293313.KAM.stores_information_xiaoyang`
WHERE internal = 0)
)
)
WHERE rank_1=1
-- )a1
-- left join `admin-account-293313.key_hll_table.fx_referrer_os_0916_utc8_tongbin_origin` b1
-- on date(a1.time,'Asia/Shanghai') = b1.date and a1.client_id = b1.client_id
)b
using(order_id)
-- left join unnest(JSON_extract_array(order_discount)) od
-- left join unnest(JSON_extract_array(product_ids)) product_ids
#去掉cod的订单
-- where order_id not in 
-- (
-- SELECT distinct order_id FROM `central-equinox-282901.shoplaza_analysis.realtime_events` 
-- where event = 'place_order'
-- and payment_method ='cod'
-- )
-- and json_extract_scalar(od,'$.discount_id') is not null
group by 1,2,3,4,5,6,7,8,9,10,11,12
),


#营销插件曝光
plugin_pv as
(
select 
date(time,'Asia/Shanghai') prc_date,
app_name,
store_id,
client_id,
country,
os,
browser,
-- b1.fx_channel
CASE
WHEN url LIKE '%gclid=%' OR referrer_host LIKE '%gclid=%' THEN 'google_ads'
WHEN referrer_host LIKE '%google.%'
OR latest_referrer_host LIKE '%google.%' THEN 'google'
WHEN referrer_host LIKE '%facebook.%' OR latest_referrer_host LIKE '%facebook.%' OR browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
WHEN referrer_host LIKE '%instagram.%'
OR latest_referrer_host LIKE '%instagram.%'
OR browser = 'Instagram' THEN 'instagram'
WHEN referrer_host LIKE '%pinterest.%' OR latest_referrer_host LIKE '%pinterest.%' OR browser = 'Pinterest' THEN 'pinterest'
WHEN referrer_host LIKE '%snapchat.%'
OR latest_referrer_host LIKE '%snapchat.%'
OR browser = 'Snapchat' THEN 'snapchat'
WHEN user_agent LIKE '%ByteLocale%' OR referrer_host LIKE '%tiktok%.' OR latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
WHEN referrer_host LIKE '%youtube.%'
OR latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
WHEN referrer_host LIKE '%yandex.%' OR latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
WHEN referrer_host LIKE '%yahoo.%'
OR latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
WHEN referrer_host LIKE '%linkedin.%' OR latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
ELSE 'others' END fx_channel--渠道分类
-- split(discount_ids,'"')[safe_ordinal(2)] discount_id,
from
(
-- select
-- * 
-- from 
-- (
SELECT 
id,
time,
case when event = 'plugin_rebate_pv' then '满减活动'
when event = 'plugin_coupon_pv' then '优惠码'
when event = 'plugin_flashsale_pv' then '限时促销'
when event in ('plugin_bundle_combination_pv','plugin_bundle_bottom_bar_pv') then '捆绑销售'
when event in ('crow_combinations_pv') then '款式组合'
when event = 'plugin_atc_view' then 'Add to Cart 设置'
when event in ('plugin_top_products_link_view','plugin_top_products_product_view') then '商品置顶'
when event in ('sales_pop_exposure') then '浮窗通知'
when event in ('plugin_discount_reduced_pv','plugin_discount_present_pv') then '满送优惠'
when event in ('plugin_recommend_rule_pv') then '自定义推荐'
end app_name,
store_id,
client_id,
country,
os,
browser,
-- max(if(p.key ='discount_ids',concat(ifnull(p.string_value,''),ifnull(cast(p.int_value as string),''),ifnull(cast(p.float_value as string),''),ifnull(cast(p.bool_value as string),'')),null)) discount_ids,
#非款式组合的style字段
max(if(p.key ='style',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),null)) style,
#款式组合不上报style的记录都筛掉
max(if(p.key ='style' and event in ('crow_combinations_pv'),CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),if(event not in ('crow_combinations_pv'),'-',null))) crow_style,
MAX(IF(p.key ='$url',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) url,
MAX(IF(p.key ='$referrer_host',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) referrer_host,
MAX(IF(p.key ='$latest_referrer_host',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) latest_referrer_host,
MAX(IF(p.key ='user_agent',CONCAT(ifnull(p.string_value,''),ifnull(CAST(p.int_value AS string),''),ifnull(CAST(p.float_value AS string),''),ifnull(CAST(p.bool_value AS string),'')),NULL)) user_agent
FROM `shoplaza.shoplaza_analysis.events_all` 
left join unnest(properties) p 
WHERE event in ('plugin_rebate_pv','plugin_coupon_pv','plugin_flashsale_pv','plugin_bundle_combination_pv','plugin_bundle_bottom_bar_pv','crow_combinations_pv','plugin_atc_view','plugin_top_products_link_view',
'plugin_top_products_product_view','sales_pop_exposure','plugin_discount_reduced_pv','plugin_discount_present_pv','plugin_recommend_rule_pv')
AND DATE(time,'Asia/Shanghai') BETWEEN begin_time AND end_time
and store_id IN (
SELECT store_id FROM `admin-account-293313.KAM.stores_information_xiaoyang`
WHERE internal = 0)
group by 1,2,3,4,5,6,7,8
)
where crow_style is not null
-- )a1
-- left join `admin-account-293313.key_hll_table.fx_referrer_os_0916_utc8_tongbin_origin` b1
-- on date(a1.time,'Asia/Shanghai') = b1.date and a1.client_id = b1.client_id
-- left join unnest(JSON_extract_array(discount_ids)) discount_ids
group by 1,2,3,4,5,6,7,8
)

#最终状态
SELECT
ifnull(pv.prc_date,pay.prc_date) prc_date,
ifnull(pv.store_id,pay.store_id) store_id,
ifnull(pv.app_name,pay.app_name) app_name,
ifnull(pv.client_id,pay.client_id) client_id,
ifnull(pv.country,pay.country) country,
ifnull(pv.os,pay.os) os,
ifnull(pv.browser,pay.browser) browser,
ifnull(pv.fx_channel,pay.fx_channel) fx_channel,
CASE WHEN pay.client_id IS NOT NULL THEN TRUE ELSE FALSE END is_paid,
pay.order_id,
pay.payment_method,
pay.order_total_price gmv,
pay.product_num
FROM
plugin_pv pv
# LEFT JOIN
# 计算那些有购买记录但无pv记录的数据，会存在多连，因为pv表和purchase表的粒度不一样，一个到client，一个到order
FULL JOIN
plugin_purchase pay
USING(prc_date,store_id,app_name,client_id,country,os,browser,fx_channel)
WHERE prc_date BETWEEN begin_time AND end_time
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
