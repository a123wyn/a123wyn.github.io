DECLARE
  begin_time date;
DECLARE
  end_time date;
SET
  begin_time = '2021-04-01';
SET
  end_time = CURRENT_DATE();
CREATE OR REPLACE TABLE
  `admin-account-293313.DWD.plugin_base_c_wyn`
PARTITION BY
  prc_date
CLUSTER BY
  app_name AS(
    # 把安装于卸载写成临时表放在这儿
    # 记得更新商品评论与反馈与评价
    # install事件
  WITH
    plugin_pv AS (
    SELECT
      prc_date,
      store_id,
      app_name,
      client_id,
      country,
      os,
      browser,
      fx_channel
    FROM (
      SELECT
        DATE(time,'Asia/Shanghai') prc_date,
        store_id,
        app_name,
        client_id,
        country,
        os,
        browser,
        CASE
          WHEN url LIKE '%gclid=%' OR referrer_host LIKE '%gclid=%' THEN 'google_ads'
          WHEN referrer_host LIKE '%google.%'
        OR latest_referrer_host LIKE '%google.%' THEN 'google'
          WHEN referrer_host LIKE '%facebook.%' OR latest_referrer_host LIKE '%facebook.%' OR browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
          WHEN referrer_host LIKE '%instagram.%'
        OR latest_referrer_host LIKE '%instagram.%'
        OR browser = 'Instagram' THEN 'instagram'
          WHEN referrer_host LIKE '%pinterest.%' OR latest_referrer_host LIKE '%pinterest.%' OR browser = 'Pinterest' THEN 'pinterest'
          WHEN referrer_host LIKE '%snapchat.%'
        OR latest_referrer_host LIKE '%snapchat.%'
        OR browser = 'Snapchat' THEN 'snapchat'
          WHEN user_agent LIKE '%ByteLocale%' OR referrer_host LIKE '%tiktok%.' OR latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
          WHEN referrer_host LIKE '%youtube.%'
        OR latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%yandex.%' OR latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%yahoo.%'
        OR latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%linkedin.%' OR latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
        ELSE
        'others'
      END
        fx_channel,
        --渠道分类
        SPLIT(discount_ids,'"')[safe_ORDINAL(2)] activity_id
      FROM (
          #dicounts_ids
        SELECT
          id,
          time,
          store_id,
          CASE
            WHEN event = 'plugin_coupon_pv' THEN '优惠码'
            WHEN event = 'plugin_rebate_pv' THEN '满减活动'
          -- WHEN event = 'plugin_flashsale_pv' THEN '限时促销'
          -- WHEN event = 'plugin_bundle_combination_pv' THEN '捆绑销售'
          -- WHEN event = 'sales_pop_exposure' THEN '浮窗通知'
          -- WHEN event = 'crow_combinations_pv' THEN '款式组合'
          -- WHEN event = 'plugin_atc_view' THEN 'Add to Cart 设置'
          -- WHEN event IN ('plugin_top_products_link_view',
            -- 'plugin_top_products_product_view') THEN '商品置顶'
        END
          app_name,
          client_id,
          country,
          os,
          browser,
          MAX(
          IF
            (p.key ='$url',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) url,
          MAX(
          IF
            (p.key ='$referrer_host',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) referrer_host,
          MAX(
          IF
            (p.key ='$latest_referrer_host',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) latest_referrer_host,
          MAX(
          IF
            (p.key ='user_agent',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) user_agent,
          MAX(
          IF
            (p.key ='discount_ids',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) discount_ids
        FROM
          `shoplaza.shoplaza_analysis.events_all`
        LEFT JOIN
          UNNEST(properties) p
        WHERE
          event IN ('plugin_coupon_pv',
            'plugin_rebate_pv'
            -- 'plugin_rebate_banner_pv',
            -- 'plugin_flashsale_pv',
            -- 'plugin_bundle_combination_pv',
            -- 'sales_pop_exposure',
            -- 'crow_combinations_pv',
            -- 'plugin_atc_view'
            )
          AND DATE(time,'Asia/Shanghai') BETWEEN begin_time
          AND end_time
          AND store_id IN (
          SELECT
            store_id
          FROM
            `admin-account-293313.KAM.stores_information_xiaoyang`
          WHERE
            internal = 0)
        GROUP BY
          1,
          2,
          3,
          4,
          5,
          6,
          7,
          8)
      LEFT JOIN
        UNNEST(JSON_extract_array(discount_ids)) discount_ids
      GROUP BY
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9)
    WHERE
      activity_id IS NOT NULL
      AND activity_id != ''
      AND activity_id != ' '
      #distinct_id
    UNION DISTINCT (
      SELECT
        DATE(time,'Asia/Shanghai') prc_date,
        store_id,
        app_name,
        client_id,
        country,
        os,
        browser,
        CASE
          WHEN url LIKE '%gclid=%' OR referrer_host LIKE '%gclid=%' THEN 'google_ads'
          WHEN referrer_host LIKE '%google.%'
        OR latest_referrer_host LIKE '%google.%' THEN 'google'
          WHEN referrer_host LIKE '%facebook.%' OR latest_referrer_host LIKE '%facebook.%' OR browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
          WHEN referrer_host LIKE '%instagram.%'
        OR latest_referrer_host LIKE '%instagram.%'
        OR browser = 'Instagram' THEN 'instagram'
          WHEN referrer_host LIKE '%pinterest.%' OR latest_referrer_host LIKE '%pinterest.%' OR browser = 'Pinterest' THEN 'pinterest'
          WHEN referrer_host LIKE '%snapchat.%'
        OR latest_referrer_host LIKE '%snapchat.%'
        OR browser = 'Snapchat' THEN 'snapchat'
          WHEN user_agent LIKE '%ByteLocale%' OR referrer_host LIKE '%tiktok%.' OR latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
          WHEN referrer_host LIKE '%youtube.%'
        OR latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%yandex.%' OR latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%yahoo.%'
        OR latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%linkedin.%' OR latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
        ELSE
        'others'
      END
        fx_channel--渠道分类
      FROM (
        SELECT
          id,
          time,
          store_id,
          CASE
            WHEN event = 'plugin_rebate_banner_pv' THEN '满减活动'
            WHEN event = 'plugin_flashsale_pv' THEN '限时促销'
            WHEN event IN('plugin_bundle_combination_pv', 'plugin_bundle_bottom_bar_pv') THEN '捆绑销售'
            WHEN event = 'sales_pop_exposure' THEN '浮窗通知'
        END
          app_name,
          client_id,
          country,
          os,
          browser,
          MAX(
          IF
            (p.key ='$url',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) url,
          MAX(
          IF
            (p.key ='$referrer_host',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) referrer_host,
          MAX(
          IF
            (p.key ='$latest_referrer_host',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) latest_referrer_host,
          MAX(
          IF
            (p.key ='user_agent',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) user_agent,
          MAX(
          IF
            (p.key ='discount_id',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) activity_id
        FROM
          `shoplaza.shoplaza_analysis.events_all`
        LEFT JOIN
          UNNEST(properties) p
        WHERE
          event IN ('plugin_rebate_banner_pv',
            'plugin_flashsale_pv',
            'plugin_bundle_combination_pv',
            'sales_pop_exposure')
          AND DATE(time,'Asia/Shanghai') BETWEEN begin_time
          AND end_time
          AND store_id IN (
          SELECT
            store_id
          FROM
            `admin-account-293313.KAM.stores_information_xiaoyang`
          WHERE
            internal = 0)
        GROUP BY
          1,
          2,
          3,
          4,
          5,
          6,
          7,
          8)
      WHERE
        activity_id IS NOT NULL
        AND activity_id != ''
        AND activity_id != ' '
      GROUP BY
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8 )
      # 没有discount的情况
    UNION DISTINCT (
      SELECT
        DATE(time,'Asia/Shanghai') prc_date,
        store_id,
        app_name,
        client_id,
        country,
        os,
        browser,
        CASE
          WHEN url LIKE '%gclid=%' OR referrer_host LIKE '%gclid=%' THEN 'google_ads'
          WHEN referrer_host LIKE '%google.%'
        OR latest_referrer_host LIKE '%google.%' THEN 'google'
          WHEN referrer_host LIKE '%facebook.%' OR latest_referrer_host LIKE '%facebook.%' OR browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
          WHEN referrer_host LIKE '%instagram.%'
        OR latest_referrer_host LIKE '%instagram.%'
        OR browser = 'Instagram' THEN 'instagram'
          WHEN referrer_host LIKE '%pinterest.%' OR latest_referrer_host LIKE '%pinterest.%' OR browser = 'Pinterest' THEN 'pinterest'
          WHEN referrer_host LIKE '%snapchat.%'
        OR latest_referrer_host LIKE '%snapchat.%'
        OR browser = 'Snapchat' THEN 'snapchat'
          WHEN user_agent LIKE '%ByteLocale%' OR referrer_host LIKE '%tiktok%.' OR latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
          WHEN referrer_host LIKE '%youtube.%'
        OR latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%yandex.%' OR latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%yahoo.%'
        OR latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
          WHEN referrer_host LIKE '%linkedin.%' OR latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
        ELSE
        'others'
      END
        fx_channel--渠道分类
      FROM (
        SELECT
          id,
          time,
          store_id,
          CASE
            WHEN event = 'crow_combinations_pv' THEN '款式组合'
            WHEN event = 'plugin_atc_view' THEN 'Add to Cart 设置'
            WHEN event IN ('plugin_top_products_link_view', 'plugin_top_products_product_view') THEN '商品置顶'
        END
          app_name,
          client_id,
          country,
          os,
          browser,
          MAX(
          IF
            (p.key ='$url',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) url,
          MAX(
          IF
            (p.key ='$referrer_host',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) referrer_host,
          MAX(
          IF
            (p.key ='$latest_referrer_host',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) latest_referrer_host,
          MAX(
          IF
            (p.key ='user_agent',
              CONCAT(ifnull(p.string_value,
                  ''),ifnull(CAST(p.int_value AS string),
                  ''),ifnull(CAST(p.float_value AS string),
                  ''),ifnull(CAST(p.bool_value AS string),
                  '')),
              NULL)) user_agent
        FROM
          `shoplaza.shoplaza_analysis.events_all`
        LEFT JOIN
          UNNEST(properties) p
        WHERE
          event IN ( 'crow_combinations_pv',
            'plugin_atc_view',
            'plugin_top_products_link_view',
            'plugin_top_products_product_view')
          AND DATE(time,'Asia/Shanghai') BETWEEN begin_time
          AND end_time
          AND store_id IN (
          SELECT
            store_id
          FROM
            `admin-account-293313.KAM.stores_information_xiaoyang`
          WHERE
            internal = 0)
        GROUP BY
          1,
          2,
          3,
          4,
          5,
          6,
          7,
          8)
      GROUP BY
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8 ) ),
    # 各插件客户支付情况
    plugin_pay AS(
    SELECT
      purchase.prc_date,
      purchase.store_id,
      purchase.app_name,
      purchase.order_id,
      ifnull(purchase.client_id,
        t_gmv.client_id) client_id,
      ifnull(purchase.country,
        t_gmv.country) country,
      ifnull(purchase.os,
        t_gmv.os) os,
      ifnull(purchase.browser,
        t_gmv.browser) browser,
      ifnull(purchase.fx_channel,
        t_gmv.fx_channel) fx_channel,
    -- IF
    --   (t_gmv.order_total_price=0,
    --   purchase.order_total_price,
    --     t_gmv.order_total_price) order_total_price,
      -- purchase.order_total_price,
      t_gmv.order_total_price,
    -- IF
    --   (t_pro_num.product_num=0,
    --   purchase.product_num,
    --     t_pro_num.product_num) product_num
      -- purchase.product_num
      t_pro_num.product_num
    FROM (
      SELECT
        DATE(time,'Asia/Shanghai') prc_date,
        store_id,
        app_name,
        client_id,
        order_id,
        country,
        os,
        browser,
        fx_channel,
        CAST(order_total_price AS float64) order_total_price,
        COUNT(DISTINCT product_ids_1) product_num
      FROM (
        SELECT
          id,
          time,
          store_id,
          app_name,
          client_id,
          order_discount,
          order_total_price,
          order_id,
          discount_total_price,
          product_ids,
          country,
          os,
          browser,
          CASE
            WHEN url LIKE '%gclid=%' OR referrer_host LIKE '%gclid=%' THEN 'google_ads'
            WHEN referrer_host LIKE '%google.%'
          OR latest_referrer_host LIKE '%google.%' THEN 'google'
            WHEN referrer_host LIKE '%facebook.%' OR latest_referrer_host LIKE '%facebook.%' OR browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
            WHEN referrer_host LIKE '%instagram.%'
          OR latest_referrer_host LIKE '%instagram.%'
          OR browser = 'Instagram' THEN 'instagram'
            WHEN referrer_host LIKE '%pinterest.%' OR latest_referrer_host LIKE '%pinterest.%' OR browser = 'Pinterest' THEN 'pinterest'
            WHEN referrer_host LIKE '%snapchat.%'
          OR latest_referrer_host LIKE '%snapchat.%'
          OR browser = 'Snapchat' THEN 'snapchat'
            WHEN user_agent LIKE '%ByteLocale%' OR referrer_host LIKE '%tiktok%.' OR latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
            WHEN referrer_host LIKE '%youtube.%'
          OR latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
            WHEN referrer_host LIKE '%yandex.%' OR latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
            WHEN referrer_host LIKE '%yahoo.%'
          OR latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
            WHEN referrer_host LIKE '%linkedin.%' OR latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
          ELSE
          'others'
        END
          fx_channel--渠道分类
        FROM (
          SELECT
            *,
            ROW_NUMBER() OVER(PARTITION BY order_id, client_id, store_id, app_name ORDER BY time DESC) rank_1 #重复数据是解析了product_ids后的数据
          FROM (
            SELECT
              id,
              time,
              store_id,
              CASE
                WHEN event IN ('plugin_activity_pv_purchase', 'plugin_coupon_get_code_purchase') THEN '优惠码'
                WHEN event IN ('plugin_rebate_pv_purchase',
                'plugin_rebate_banner_pv_purchase',
                'plugin_rebate_atc_purchase') THEN '满减活动'
                WHEN event IN ('plugin_flashsale_pv_purchase', 'plugin_flashsale_atc_purchase', 'plugin_flashsale_purchase') THEN '限时促销'
                WHEN event = 'sales_pop_purchase' THEN '浮窗通知'
                WHEN event = 'crow_combinations_purchase' THEN '款式组合'
                WHEN event = 'plugin_atc_checkout_purchase' THEN 'Add to Cart 设置'
                WHEN event IN ('plugin_top_products_purchase', 'plugin_top_products_indirect_purchase') THEN '商品置顶'
            END
              app_name,
              client_id,
              country,
              os,
              browser,
              MAX(
              IF
                (p.key ='order_discount',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) order_discount,
              MAX(
              IF
                (p.key ='order_total_price'
                  OR p.key ='total_price'
                  OR p.key = 'total',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) order_total_price,
              MAX(
              IF
                (p.key ='order_id',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) order_id,
              MAX(
              IF
                (p.key ='discount_total_price',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) discount_total_price,
              MAX(
              IF
                (p.key ='product_ids',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) product_ids,
              MAX(
              IF
                (p.key ='$url',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) url,
              MAX(
              IF
                (p.key ='$referrer_host',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) referrer_host,
              MAX(
              IF
                (p.key ='$latest_referrer_host',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) latest_referrer_host,
              MAX(
              IF
                (p.key ='user_agent',
                  CONCAT(ifnull(p.string_value,
                      ''),ifnull(CAST(p.int_value AS string),
                      ''),ifnull(CAST(p.float_value AS string),
                      ''),ifnull(CAST(p.bool_value AS string),
                      '')),
                  NULL)) user_agent
            FROM
              `shoplaza.shoplaza_analysis.events_all`
            LEFT JOIN
              UNNEST(properties) p
            WHERE
              event IN ('plugin_activity_pv_purchase',
                'plugin_coupon_get_code_purchase',
                'plugin_rebate_pv_purchase',
                'plugin_rebate_banner_pv_purchase',
                'plugin_rebate_atc_purchase',
                'plugin_flashsale_pv_purchase',
                'plugin_flashsale_atc_purchase',
                'plugin_flashsale_purchase',
                'sales_pop_purchase',
                'crow_combinations_purchase',
                'plugin_atc_checkout_purchase',
                'plugin_top_products_purchase',
                'plugin_top_products_indirect_purchase')
              AND DATE(time,'Asia/Shanghai') BETWEEN begin_time
              AND end_time
              AND store_id IN (
              SELECT
                store_id
              FROM
                `admin-account-293313.KAM.stores_information_xiaoyang`
              WHERE
                internal = 0)
            GROUP BY
              1,
              2,
              3,
              4,
              5,
              6,
              7,
              8))
        WHERE
          rank_1 = 1)
      LEFT JOIN
        UNNEST(JSON_extract_array(order_discount)) od
      LEFT JOIN
        UNNEST(JSON_extract_array(product_ids)) product_ids_1
      WHERE
        order_id IS NOT NULL
        -- AND od IS NOT NULL
        AND json_extract_scalar(od,
            '$.discount_id') IS NOT NULL
        AND json_extract_scalar(od,
            '$.discount_id')!= ''
        AND json_extract_scalar(od,
            '$.discount_id')!=' ' #去掉discount为空的情况
        or app_name in ('浮窗通知','款式组合','Add to Cart 设置','商品置顶')
      GROUP BY
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10)purchase
      #限时促销purchase无clientid
      -- LEFT JOIN (
        --   SELECT
        --     order_id,
        --     client_id,
        --     country,
        --     os,
        --     browser,
        --     fx_channel
        --   FROM (
          --     SELECT
          --       *,
          --       ROW_NUMBER() OVER(PARTITION BY order_id, client_id ORDER BY time DESC) rank_1
          --     FROM (
            --       SELECT
            --         id,
            --         time,
            --         order_id,
            --         client_id,
            --         country,
            --         _os os,
            --         _browser browser,
            --         CASE
            --           WHEN _url LIKE '%gclid=%' OR _referrer_host LIKE '%gclid=%' THEN 'google_ads'
            --           WHEN _referrer_host LIKE '%google.%'
            --         OR _latest_referrer_host LIKE '%google.%' THEN 'google'
            --           WHEN _referrer_host LIKE '%facebook.%' OR _latest_referrer_host LIKE '%facebook.%' OR _browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
            --           WHEN _referrer_host LIKE '%instagram.%'
            --         OR _latest_referrer_host LIKE '%instagram.%'
            --         OR _browser = 'Instagram' THEN 'instagram'
            --           WHEN _referrer_host LIKE '%pinterest.%' OR _latest_referrer_host LIKE '%pinterest.%' OR _browser = 'Pinterest' THEN 'pinterest'
            --           WHEN _referrer_host LIKE '%snapchat.%'
            --         OR _latest_referrer_host LIKE '%snapchat.%'
            --         OR _browser = 'Snapchat' THEN 'snapchat'
            --           WHEN user_agent LIKE '%ByteLocale%' OR _referrer_host LIKE '%tiktok%.' OR _latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
            --           WHEN _referrer_host LIKE '%youtube.%'
            --         OR _latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
            --           WHEN _referrer_host LIKE '%yandex.%' OR _latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
            --           WHEN _referrer_host LIKE '%yahoo.%'
            --         OR _latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
            --           WHEN _referrer_host LIKE '%linkedin.%' OR _latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
            --         ELSE
            --         'others'
            --       END
            --         fx_channel--渠道分类
            --       FROM
            --         `central-equinox-282901.shoplaza_analysis.realtime_events`
            --       WHERE
            --         event = 'place_order'
            --         AND platform = 'shop'
            --         AND payment_method != 'cod' ))
        --   WHERE
        --     rank_1 = 1)if_client_null
      -- USING
      --   (order_id)
      #外连接realtime获取gmv
    LEFT JOIN (
      SELECT
        DATE(time,'Asia/Shanghai') prc_date,
        order_id,
        client_id,
        country,
        os,
        browser,
        fx_channel,
        store_id,
        SUM(order_total_price) order_total_price
      FROM (
        SELECT
          *,
          ROW_NUMBER() OVER(PARTITION BY order_id, client_id, store_id ORDER BY time DESC) rank_1
        FROM (
          SELECT
            id,
            time,
            order_id,
            client_id,
            country,
            _os os,
            _browser browser,
            CASE
              WHEN _url LIKE '%gclid=%' OR _referrer_host LIKE '%gclid=%' THEN 'google_ads'
              WHEN _referrer_host LIKE '%google.%'
            OR _latest_referrer_host LIKE '%google.%' THEN 'google'
              WHEN _referrer_host LIKE '%facebook.%' OR _latest_referrer_host LIKE '%facebook.%' OR _browser IN('Facebook', 'Facebook Messenger', 'FacebookBot') THEN 'facebook'
              WHEN _referrer_host LIKE '%instagram.%'
            OR _latest_referrer_host LIKE '%instagram.%'
            OR _browser = 'Instagram' THEN 'instagram'
              WHEN _referrer_host LIKE '%pinterest.%' OR _latest_referrer_host LIKE '%pinterest.%' OR _browser = 'Pinterest' THEN 'pinterest'
              WHEN _referrer_host LIKE '%snapchat.%'
            OR _latest_referrer_host LIKE '%snapchat.%'
            OR _browser = 'Snapchat' THEN 'snapchat'
              WHEN user_agent LIKE '%ByteLocale%' OR _referrer_host LIKE '%tiktok%.' OR _latest_referrer_host LIKE '%tiktok.%' THEN 'tiktok' -- 2021-07-14新增user_agent判断条件
              WHEN _referrer_host LIKE '%youtube.%'
            OR _latest_referrer_host LIKE '%youtube.%' THEN 'youtube'  -- 2021-07-05新增
              WHEN _referrer_host LIKE '%yandex.%' OR _latest_referrer_host LIKE '%yandex.%' THEN 'yandex'  -- 2021-07-05新增
              WHEN _referrer_host LIKE '%yahoo.%'
            OR _latest_referrer_host LIKE '%yahoo.%' THEN 'yahoo'  -- 2021-07-05新增
              WHEN _referrer_host LIKE '%linkedin.%' OR _latest_referrer_host LIKE '%linkedin.%' THEN 'linkedin'  -- 2021-07-05新增
            ELSE
            'others'
          END
            fx_channel,
            --渠道分类
            store_id,
            SUM(usd_total) order_total_price
          FROM
            `central-equinox-282901.shoplaza_analysis.realtime_events`
          WHERE
            event = 'place_order'
            AND platform = 'shop'
            AND payment_method != 'cod'
            AND DATE(time,'Asia/Shanghai') BETWEEN begin_time
            AND end_time
          GROUP BY
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9))
      WHERE
        rank_1=1
      GROUP BY
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8)t_gmv
    ON
      -- purchase.prc_date = t_gmv.prc_date
      purchase.order_id = t_gmv.order_id
      AND purchase.client_id = t_gmv.client_id
      AND purchase.store_id = t_gmv.store_id
      #外连realtime获取商品数量
    LEFT JOIN (
      SELECT
        DATE(time,'Asia/Shanghai') prc_date,
        order_id,
        client_id,
        store_id,
        SUM(product_num) product_num
      FROM (
        SELECT
          *,
          ROW_NUMBER() OVER(PARTITION BY order_id, client_id, store_id ORDER BY time DESC) rank_1
        FROM (
          SELECT
            id,
            time,
            order_id,
            client_id,
            store_id,
            SUM(quantity) product_num
          FROM
            `central-equinox-282901.shoplaza_analysis.realtime_events`
          WHERE
            event = 'purchase_product'
            AND platform = 'shop'
            AND payment_method != 'cod'
            AND DATE(time,'Asia/Shanghai') BETWEEN begin_time
            AND end_time
          GROUP BY
            1,
            2,
            3,
            4,
            5))
      WHERE
        rank_1=1
      GROUP BY
        1,
        2,
        3,
        4)t_pro_num
    ON
      -- purchase.prc_date = t_pro_num.prc_date
      purchase.order_id = t_pro_num.order_id
      AND purchase.client_id = t_pro_num.client_id
      AND purchase.store_id = t_pro_num.store_id
      ),
    #拼表
    plugin_pinjie AS(
    SELECT
      pv.prc_date,
      pv.store_id,
      pv.app_name,
      pv.client_id,
      pv.country,
      pv.os,
      pv.browser,
      pv.fx_channel,
      CASE
        WHEN pay.client_id IS NOT NULL THEN TRUE
      ELSE
      FALSE
    END
      is_paid,
      pay.order_id,
      pay.order_total_price gmv,
      pay.product_num
    FROM
      plugin_pv pv
      # LEFT JOIN
      # 计算那些有购买记录但无pv记录的数据，会存在多连，因为pv表和purchase表的粒度不一样，一个到client，一个到order
    FULL JOIN
      plugin_pay pay
    USING
      (prc_date,
        store_id,
        app_name,
        client_id
        -- country,
        -- os,
        -- browser,
        -- fx_channel
        )
    WHERE
      prc_date BETWEEN begin_time
      AND end_time )
    # 插件C端营销数据指标计算
    # 日期-店铺-插件维度C端数据
  SELECT
    prc_date,
    app_name,
    -- store_id,
    platform_gmv.total_gmv,
    COUNT(DISTINCT
      CASE
        WHEN is_paid IS TRUE THEN client_id
    END
      ) paid_client_num,
    COUNT(DISTINCT
      CASE
        WHEN is_paid IS TRUE THEN order_id
    END
      ) paid_order_num,
    SUM(CASE
        WHEN is_paid IS TRUE THEN gmv
      ELSE
      0
    END
      ) gmv,
    SUM(CASE
        WHEN is_paid IS TRUE THEN gmv
      ELSE
      0
    END
      )/nullif(total_gmv,
      0) gmv_rate,
    COUNT(DISTINCT
      CASE
        WHEN is_paid IS TRUE THEN order_id
    END
      )/nullif(COUNT(DISTINCT client_id),
      0) conversion_rate,
    SUM(CASE
        WHEN is_paid IS TRUE THEN product_num
      ELSE
      0
    END
      ) paid_pro_num,
    SUM(CASE
        WHEN is_paid IS TRUE THEN product_num
      ELSE
      0
    END
      )/nullif(COUNT(DISTINCT
        CASE
          WHEN is_paid IS TRUE THEN order_id
      END
        ),
      0) liandai_rate
  FROM
    plugin_pinjie
  LEFT JOIN (
    SELECT
      DATE(prc_time) prc_date,
      -- store_id,
      SUM(usd_total) total_gmv
    FROM
      `central-equinox-282901.shoplaza_analysis.realtime_events`
    WHERE
      event = 'place_order'
      AND platform = 'shop'
      AND payment_method != 'cod'
      AND DATE(prc_time) BETWEEN begin_time
      AND end_time
    GROUP BY
      1)platform_gmv
  USING
    (prc_date)
  GROUP BY
    1,
    2,
    3)